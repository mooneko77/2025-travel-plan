<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ‡®ğŸ‡¹ Italy Trip Planner 2025 - AI Enabled</title>
    
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- è¼‰å…¥ Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- è¼‰å…¥ Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // --- ç¾…é¦¬ç«¶æŠ€å ´ä¸»é¡Œè‰²ç³» ---
                        'colosseum-dark': '#793A2D',    // æ·±èµ¤é™¶è‰² (åŸ deep-sea-blue)
                        'stone-dark': '#4A433A',        // æ·±çŸ³ç°è‰² (åŸ med-blue)
                        'stone-light': '#D4BF9B',       // æš–æ·ºçŸ³è‰² (åŸ sky-blue)
                        'roman-bronze': '#C5A35E',      // ç¾…é¦¬é’éŠ…è‰² (åŸ accent-gold)
                        
                        // åŸºç¤è‰²
                        'marble-white': '#F9F5EF',      // æº«æš–çš„èƒŒæ™¯åº•è‰² (åŸ F9F9F9)
                        'soft-gray': '#E5E7EB',         // èƒŒæ™¯ç° (ä¸è®Š)
                        
                        // AI åŠŸèƒ½è‰² (ä¿æŒé«˜å°æ¯”åº¦ç²‰è‰²)
                        'ai-pink': '#EC4899',           
                        'ai-light-pink': '#FDF2F8',     
                    }
                }
            }
        }
    </script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body {
            /* èª¿æ•´ç‚ºæš–æ·ºç±³è‰² */
            background-color: #F9F5EF; 
            -webkit-tap-highlight-color: transparent;
            font-family: 'Noto Sans TC', sans-serif;
            color: #334155;
        }

        .app-container {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            background-color: #ffffff; 
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.05);
            position: relative;
            padding-bottom: 90px;
        }

        /* --- é é¦– (Head/Banner) --- */
        .header-bg {
            background-color: #ffffff; 
            padding: 0; 
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15); 
            border-bottom-left-radius: 35px; 
            border-bottom-right-radius: 35px;
            z-index: 10; 
            padding-bottom: 0px; 
        }
        
        .header-image-container {
            width: 100%;
            height: 250px; 
            overflow: hidden;
            /* èª¿æ•´ç‚ºé…åˆç«¶æŠ€å ´çš„æ·±åœŸè‰² */
            background-color: #A36B5C; 
            border-bottom-left-radius: 35px; 
            border-bottom-right-radius: 35px;
        }
        
        .header-image-container img {
            width: 100%;
            height: 100%;
            object-fit: cover; 
            display: block; 
        }
        
        /* ç§»é™¤é›ªèŠ±åœ–å±¤ï¼Œæ”¹ç”¨æŸ”å’Œé™°å½± */
        .snow-layer { display: none; } 
        
        /* --- Tab Bar --- */
        .side-tab-bar {
            position: absolute;
            bottom: 45px; 
            right: 16px;
            z-index: 30;
            display: flex;
            flex-direction: row;
            gap: 8px; 
        }
        
        .tab-button {
            width: 40px; 
            height: 40px;
            border-radius: 9999px; 
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem; 
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15); 
            transition: all 0.2s ease;
        }
        
        .tab-button.active {
            /* æ›¿æ›ç‚ºæ·±èµ¤é™¶è‰² */
            background-color: #793A2D; 
            color: #ffffff;
            box-shadow: 0 6px 15px rgba(121, 58, 45, 0.4); 
            transform: scale(1.05);
        }
        
        .tab-button:not(.active) {
            background-color: #ffffff;
            /* æ›¿æ›ç‚ºæš–æ·ºçŸ³è‰² */
            color: #D4BF9B; 
        }


        /* --- Main Content --- */
        .app-main {
            padding-top: 25px !important; 
            position: relative;
            z-index: 5;
        }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .card-shadow {
            /* æ›¿æ›ç‚ºæš–çŸ³è‰²çš„é™°å½± */
            box-shadow: 0 4px 20px rgba(212, 191, 155, 0.5); 
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .animate-fade-in { animation: fadeIn 0.4s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fab-shadow {
            /* æ›¿æ›ç‚ºç¾…é¦¬é’éŠ…è‰²çš„é™°å½± */
            box-shadow: 0 4px 15px rgba(197, 163, 94, 0.5); 
        }

        .note-content {
            max-height: 2.5rem;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .note-content.expanded {
            max-height: 500px;
        }
        
        .expense-category-tag {
            min-width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .expenses-banner {
            /* æ›¿æ›ç‚ºæ·±çŸ³ç°åˆ°æ·±èµ¤é™¶è‰²çš„æ¼¸è®Š */
            background: linear-gradient(135deg, #4A433A 0%, #793A2D 100%); 
        }
        
        .date-selector-sticky {
            background-color: #ffffff;
            border-bottom: 1px solid #f0f0f0; 
            z-index: 20; 
            top: 0; 
        }
        
        .ai-recommendation-output {
            white-space: pre-wrap;
            line-height: 1.5;
            padding: 10px;
            margin-top: 10px;
            background-color: #FDF2F8; /* ai-light-pink */
            border-radius: 12px;
            border: 1px solid #FBCFE8; /* Pink-200 */
        }
    </style>
</head>
<body>

<div id="app" class="app-container">

    <div class="header-bg relative">
        <div class="header-image-container">
            <!-- æ›¿æ›ç‚ºç¾…é¦¬ç«¶æŠ€å ´ä¸»é¡Œ Placeholder -->
            <img src="https://placehold.co/480x250/A36B5C/E0C39C?text=The+Colosseum" alt="ç¾©å¤§åˆ©å®¶æ—æ—…è¡Œè¨ˆç•« - ç¾…é¦¬ç«¶æŠ€å ´ä¸»é¡Œ">
        </div>
        
        <div class="snow-layer"></div> 
        
        <div class="side-tab-bar">
            <button @click="currentTab = 'itinerary'" title="è¡Œç¨‹" 
                    :class="{'active': currentTab === 'itinerary'}" 
                    class="tab-button">
                <i class="fa-solid fa-map-location-dot"></i>
            </button>
            
            <button @click="currentTab = 'outfit'" title="ç©¿æ­" 
                    :class="{'active': currentTab === 'outfit'}" 
                    class="tab-button">
                <i class="fa-solid fa-shirt"></i>
            </button>
            
            <button @click="currentTab = 'info'" title="è³‡è¨Š" 
                    :class="{'active': currentTab === 'info'}" 
                    class="tab-button">
                <i class="fa-solid fa-circle-info"></i>
            </button>
            
            <button @click="currentTab = 'shopping'" title="è³¼ç‰©" 
                    :class="{'active': currentTab === 'shopping'}" 
                    class="tab-button">
                <i class="fa-solid fa-basket-shopping"></i>
            </button>
            
            <button @click="currentTab = 'expenses'" title="èŠ±è²»" 
                    :class="{'active': currentTab === 'expenses'}" 
                    class="tab-button">
                <i class="fa-solid fa-coins"></i>
            </button>
            
            <!-- æ–°å¢ AI å·¥å…· Tab -->
            <button @click="currentTab = 'ai-tools'" title="AIå·¥å…·" 
                    :class="{'active': currentTab === 'ai-tools'}" 
                    class="tab-button bg-ai-pink hover:bg-ai-pink/80">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
            </button>
        </div>
        </div>

    
    <main class="p-4 app-main">
        
        <!-- è¡Œç¨‹é  -->
        <div v-if="currentTab === 'itinerary'" class="animate-fade-in">
            
            <div class="flex overflow-x-auto hide-scrollbar space-x-3 pb-4 mb-2 snap-x px-1 sticky date-selector-sticky pt-1 -mx-4 px-4">
                <div v-for="(day, index) in dates" :key="index" 
                     @click="selectedDateIndex = index"
                     class="snap-center flex-shrink-0 w-[58px] h-[68px] rounded-xl flex flex-col items-center justify-center cursor-pointer transition-all duration-300 border-2 shadow-sm"
                     :class="selectedDateIndex === index ?
'bg-colosseum-dark text-white border-colosseum-dark shadow-lg scale-105' : 'bg-white text-slate-400 border-white hover:bg-soft-gray'">
                    
                    <span class="text-sm font-bold uppercase tracking-wider">{{ day.weekday }}</span> 
                    <span class="text-xs font-medium opacity-70">{{ day.date }}</span> 
                </div>
            </div>

            <div v-if="weatherData[selectedDateIndex]" class="mb-4 bg-marble-white border border-stone-light/50 rounded-2xl p-4 flex justify-between items-center shadow-md">
                
                <!-- å·¦å´ï¼šå¤©æ°£èˆ‡æ°£æº« -->
                <div class="flex items-start text-colosseum-dark space-x-4">
                    <i :class="getWeatherIcon(weatherData[selectedDateIndex].condition)" class="text-5xl text-stone-dark"></i>
                    
                    <div class="pt-1">
                        <span class="text-3xl font-extrabold leading-none">{{ weatherData[selectedDateIndex].temp.split('/')[0] }}Â°</span>
                        <span class="text-sm font-light text-slate-500 ml-1">/ {{ weatherData[selectedDateIndex].temp.split('/')[1] }}Â°C</span>
                        <span class="block text-xs text-slate-600 mt-1">é«”æ„Ÿ: {{ weatherData[selectedDateIndex].feel }}Â°C</span> 
                    </div>
                </div>
                
                <!-- å³å´ï¼šåŒ¯ç‡èˆ‡äº¤é€š -->
                <div class="text-right text-xs text-slate-600 pl-3 space-y-2">
                    <!-- æ¯æ—¥åŒ¯ç‡é¡¯ç¤º -->
                    <div class="bg-roman-bronze/10 text-colosseum-dark px-2 py-1 rounded-lg border border-roman-bronze/30 font-bold">
                        <i class="fa-solid fa-arrow-right-arrow-left text-xs mr-1"></i> 
                        â‚¬1 = NT$ {{ weatherData[selectedDateIndex].exchangeRate }}
                    </div>
                    
                    <span class="font-bold block text-slate-700">{{ getWeatherDescription(weatherData[selectedDateIndex].condition) }}</span>
                    
                    <span v-if="dates[selectedDateIndex].hasCar" class="mt-1 block text-colosseum-dark font-bold">
                        <i class="fa-solid fa-car-side mr-1 text-roman-bronze"></i> ç§Ÿè»Šæ—¥
                        <span v-if="dates[selectedDateIndex].tollFee" class="ml-2 bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">
                            â‚¬{{ formatNumber(dates[selectedDateIndex].tollFee) }}
                        </span>
                    </span>
                    <span v-else class="mt-1 block text-slate-400">æœ¬æ—¥æ­¥è¡Œ/å¤§çœ¾é‹è¼¸</span>
                </div>
            </div>

            <div class="space-y-4">
                <div v-for="(item, idx) in currentItinerary" :key="item.id" class="relative group">
                    
                    <div v-if="idx > 
0" class="pl-8 pb-2 flex items-center text-xs text-slate-400">
                        <div class="h-6 w-0.5 bg-slate-200 absolute left-6 -top-3"></div>
                        
                        <i :class="getTransportIcon(currentItinerary[idx].transportType)" 
                            class="mr-2 text-slate-300 cursor-pointer hover:text-colosseum-dark transition-colors" 
                            @click="openMapDirections(currentItinerary[idx - 1], item)">
                        </i>
                        <span class="font-bold">{{ item.travelTime ||
'ç´„ 15 åˆ†é˜' }}</span>
                    </div>
                    
                    <div class="bg-white rounded-3xl p-5 card-shadow relative overflow-hidden flex items-start border border-stone-light/50">
                        
                        <div class="mr-4 flex flex-col items-center min-w-[50px]">
                            <div class="p-2 rounded-full text-white shadow-md text-base mb-1" :class="getCategoryColor(item.category)">
                                <i :class="getCategoryIcon(item.category)"></i>
                            </div>
                            <span v-if="item.startTime" class="text-xs font-bold text-slate-600 mt-1">{{ item.startTime }}</span>
                        </div>

                        <div class="flex-1 pb-1">
                            <h3 class="text-lg font-bold text-slate-800 mb-1 leading-tight pr-8">{{ item.name }}</h3>
                            
                            <div 
class="text-sm text-slate-500 space-y-1.5 mt-2">
                                <p v-if="item.hours" class="flex items-center"><i class="fa-regular fa-clock w-4 text-center mr-2 text-stone-light"></i> ç‡Ÿæ¥­: {{ item.hours }}</p>
                                <p v-if="item.price" class="flex items-center"><i class="fa-solid fa-ticket w-4 text-center mr-2 text-stone-light"></i> é–€ç¥¨/è²»ç”¨: {{ item.price }}</p>
                                <p v-if="item.address" class="flex items-start"><i class="fa-solid fa-location-dot w-4 text-center mr-2 mt-1 text-stone-light"></i> {{ item.address }}</p>
                            </div>

                            <div v-if="item.note && item.note.length > 0" 
class="mt-3 text-xs bg-slate-50 p-2.5 rounded-lg border border-slate-100">
                                <p class="text-slate-600 font-bold mb-1 flex items-center">
                                    <i class="fa-solid fa-highlighter text-roman-bronze mr-2"></i> å‚™è¨»
                                </p>
                                <div class="note-content" :class="{'expanded': item.isNoteExpanded}">
                                    {{ item.note }}
                                </div>
                                <button v-if="item.note.length > 50" @click="item.isNoteExpanded = !item.isNoteExpanded" class="text-colosseum-dark font-bold mt-1 block">
                                    {{ 
item.isNoteExpanded ? 'æ”¶åˆå‚™è¨»' : 'æŸ¥çœ‹æ›´å¤š...' }}
                                </button>
                            </div>
                            
                            <!-- AI è¡Œç¨‹å»ºè­°æŒ‰éˆ• -->
                            <div v-if="idx === currentItinerary.length - 1" class="pt-4 mt-4 border-t border-slate-100">
                                <h4 class="text-base font-semibold text-ai-pink mb-2 flex items-center">
                                    <i class="fa-solid fa-bowl-food w-4 h-4 mr-2"></i>
                                    AI æ™šé¤/å»ºè­°
                                </h4>
                                <button @click="getRecommendation(selectedDateIndex)" :disabled="isRecommendationLoading[selectedDateIndex]" 
                                        :id="'recommendBtn-' + selectedDateIndex" 
                                        class="flex items-center text-sm font-semibold text-white bg-ai-pink hover:bg-ai-pink/80 rounded-lg px-4 py-2 transition duration-150 disabled:bg-pink-300">
                                    <i :class="isRecommendationLoading[selectedDateIndex] ? 'fa-solid fa-spinner animate-spin' : 'fa-solid fa-martini-glass'" class="w-4 h-4 mr-2"></i>
                                    {{ isRecommendationLoading[selectedDateIndex] ? 'AI æ­£åœ¨æœå°‹ä¸­...' : 'æ¨è–¦ä»Šæ—¥æ™šé¤/æ´»å‹•' }}
                                </button>
                                <!-- AI å»ºè­°è¼¸å‡º -->
                                <div v-if="recommendationOutput[selectedDateIndex] && recommendationOutput[selectedDateIndex].text" 
                                     class="ai-recommendation-output">
                                     <div class="text-sm whitespace-pre-wrap text-slate-800" v-html="formatMarkdown(recommendationOutput[selectedDateIndex].text)"></div>
                                     <div v-if="recommendationOutput[selectedDateIndex].sources.length" class="mt-3 pt-2 border-t border-pink-200">
                                        <p class="text-xs text-slate-500 font-semibold mb-1">åƒè€ƒä¾†æº:</p>
                                        <div class="space-y-1">
                                            <a v-for="(source, sIdx) in recommendationOutput[selectedDateIndex].sources" :key="sIdx" 
                                               :href="source.uri" target="_blank" 
                                               class="text-colosseum-dark hover:underline text-xs block truncate" 
                                               :title="source.title || 'é»æ“ŠæŸ¥çœ‹ä¾†æº'">
                                                {{ sIdx + 1 }}. {{ source.title || 'ç„¡æ¨™é¡Œ' }}
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- End AI Feature -->
                        </div>

                        <div class="absolute top-3 right-3 flex flex-col space-y-1">
                            <button v-if="idx > 0" @click.stop="moveItineraryUp(item.id)" class="w-7 h-7 bg-slate-100 text-slate-500 rounded-full flex items-center justify-center text-xs hover:bg-slate-300 transition-colors" title="ä¸Šç§»">
                                <i class="fa-solid fa-arrow-up"></i>
                            </button>
                            <button v-if="idx < currentItinerary.length - 1" @click.stop="moveItineraryDown(item.id)" class="w-7 h-7 bg-slate-100 text-slate-500 rounded-full flex items-center justify-center text-xs hover:bg-slate-300 transition-colors" title="ä¸‹ç§»">
                                <i class="fa-solid fa-arrow-down"></i>
                            </button>
                            <button @click.stop="openMap(item.address || item.name)" class="w-7 h-7 bg-stone-light/80 text-colosseum-dark rounded-full flex items-center justify-center text-xs hover:bg-colosseum-dark hover:text-white transition-colors" title="Google Maps å°èˆª">
                                <i class="fa-solid fa-location-arrow"></i>
                            </button>
                            <button @click.stop="editItem(item)" class="w-7 h-7 bg-slate-100 text-slate-500 rounded-full flex items-center justify-center text-xs hover:bg-slate-200 transition-colors" title="ç·¨è¼¯è¡Œç¨‹">
                                <i class="fa-solid fa-pencil"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div v-if="currentItinerary.length === 0" class="text-center py-16 text-slate-300">
                    <i class="fa-solid fa-map-location-dot text-5xl mb-3 text-slate-200"></i>
                    <p class="text-sm">æœ¬æ—¥å°šç„¡è¡Œç¨‹<br>è«‹é»æ“Šå³ä¸‹è§’æ–°å¢</p>
                </div>
            </div>
        </div>
        
        <!-- æ–°å¢ï¼šç©¿æ­é é¢ -->
        <div v-if="currentTab === 'outfit'" class="animate-fade-in">
            <div class="flex overflow-x-auto hide-scrollbar space-x-3 pb-4 mb-2 snap-x px-1 sticky date-selector-sticky pt-1 -mx-4 px-4">
                <div v-for="(day, index) in dates" :key="index" 
                     @click="selectedDateIndex = index"
                     class="snap-center flex-shrink-0 w-[58px] h-[68px] rounded-xl flex flex-col items-center justify-center cursor-pointer transition-all duration-300 border-2 shadow-sm"
                     :class="selectedDateIndex === index ?
'bg-colosseum-dark text-white border-colosseum-dark shadow-lg scale-105' : 'bg-white text-slate-400 border-white hover:bg-soft-gray'">
                    
                    <span class="text-sm font-bold uppercase tracking-wider">{{ day.weekday }}</span> 
                    <span class="text-xs font-medium opacity-70">{{ day.date }}</span> 
                </div>
            </div>
            
            <div class="mb-4 bg-roman-bronze/10 border border-roman-bronze/50 rounded-2xl p-4 flex justify-between items-center shadow-md">
                <div class="text-colosseum-dark font-bold text-lg flex items-center">
                    <i class="fa-solid fa-star-of-life mr-2 text-roman-bronze"></i>
                    æœ¬æ—¥ç©¿æ­ä¸»é¡Œ
                </div>
                <div class="text-sm text-slate-600">
                    é è¨ˆæº«åº¦: {{ weatherData[selectedDateIndex].temp }}Â°C (é«”æ„Ÿ {{ weatherData[selectedDateIndex].feel }}Â°C)
                </div>
            </div>
            
            <div class="bg-white rounded-3xl p-6 card-shadow space-y-5">
                
                <!-- æ–°å¢åœ–ç‰‡ä¸Šå‚³å€ -->
                <div class="relative mb-6">
                    <input type="file" @change="handleOutfitImageUpload" class="hidden" id="outfitFileInput" accept="image/*">
                    <label for="outfitFileInput" class="w-full h-48 bg-slate-50 border-2 border-dashed border-slate-200 rounded-xl flex items-center justify-center cursor-pointer text-slate-400 hover:bg-slate-100 hover:border-border-slate-300 transition-all overflow-hidden">
                        <span v-if="!currentOutfit.image" class="flex flex-col items-center text-sm text-colosseum-dark">
                            <i class="fa-solid fa-camera text-3xl mb-2"></i> ä¸Šå‚³ä»Šæ—¥ç©¿æ­åƒè€ƒåœ–
                            <p class="mt-2 text-xs text-slate-500">(é»æ“Šæˆ–æ‹–æ›³æª”æ¡ˆ)</p>
                        </span>
                        <img v-else :src="currentOutfit.image" class="h-full w-full object-cover">
                    </label>
                    <button v-if="currentOutfit.image" @click="currentOutfit.image = null" class="absolute top-2 right-2 bg-red-600/90 text-white rounded-full w-7 h-7 flex items-center justify-center text-sm shadow-md hover:bg-red-700 transition-colors" title="ç§»é™¤åœ–ç‰‡">
                        <i class="fa-solid fa-xmark"></i>
                    </button>
                </div>
                <!-- åœ–ç‰‡ä¸Šå‚³å€çµæŸ -->

                <div class="relative">
                    <label class="text-xs text-colosseum-dark font-bold mb-1 block">ç©¿æ­ä¸»é¡Œ/é¢¨æ ¼</label>
                    <input v-model="currentOutfit.theme" type="text" placeholder="ä¾‹å¦‚ï¼šç±³è˜­æ™‚å°šè¡—æ‹é¢¨ / ç¾…é¦¬å¤è‘—é¢¨" 
                           class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-roman-bronze">
                </div>
                
                <div class="relative">
                    <label class="text-xs text-colosseum-dark font-bold mb-1 block">ä¸»è¦å–®å“ (åˆ—è¡¨)</label>
                    <textarea v-model="currentOutfit.items" rows="4" placeholder="æ¯è¡Œä¸€å€‹å–®å“ï¼Œä¾‹å¦‚ï¼š
- é»‘è‰²ç¾Šæ¯›å¤§è¡£
- ç´…è‰²é‡ç¹”è¡«
- çš®é©é•·è¤²
- ç¾…é¦¬é’éŠ…è‰²é …éŠ" 
                              class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-roman-bronze"></textarea>
                    <p class="text-xs text-slate-400 mt-1">è«‹ä½¿ç”¨æ›è¡Œåˆ†éš”å–®å“ï¼Œæ–¹ä¾¿æŸ¥çœ‹ã€‚</p>
                </div>
                
                <div class="relative">
                    <label class="text-xs text-colosseum-dark font-bold mb-1 block">å‚™è¨»/é…ä»¶/å¦å®¹</label>
                    <textarea v-model="currentOutfit.note" rows="3" placeholder="ä¾‹å¦‚ï¼šé€™å¤©æœƒä¸‹é›¨ï¼Œè¨˜å¾—å¸¶é˜²æ°´çš„é‹å­ã€‚æ‹ç…§æ™‚è¦æ­é…å¤ªé™½çœ¼é¡ã€‚" 
                              class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-roman-bronze"></textarea>
                </div>
                
                <button @click="saveOutfit" class="w-full py-3 rounded-xl bg-colosseum-dark text-white font-bold text-sm shadow-lg shadow-colosseum-dark/30 transition-all hover:bg-stone-dark">
                    <i class="fa-solid fa-save mr-2"></i> å„²å­˜ä»Šæ—¥ç©¿æ­
                </button>
            </div>
        </div>

        <!-- è³‡è¨Šé  -->
        <div v-if="currentTab === 'info'" class="space-y-5 animate-fade-in">
            
            <!-- æ›¿æ›ç‚ºç¾…é¦¬è‰²ç³»æ¼¸è®Š -->
            <div class="bg-gradient-to-r from-stone-dark to-colosseum-dark rounded-3xl p-6 text-white shadow-xl relative overflow-hidden">
                <div class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full -mr-10 -mt-10 blur-2xl"></div>
                <div class="absolute bottom-0 left-0 w-32 h-32 
bg-white/10 rounded-full -ml-10 -mb-10 blur-2xl"></div>
                <h3 class="font-bold text-lg mb-4 flex items-center relative z-10"><i class="fa-solid fa-calculator mr-2"></i> åŒ¯ç‡æ›ç®—</h3>
                <div class="flex items-center justify-between space-x-3 relative z-10">
                    <div class="flex-1">
                        <label class="text-[10px] 
text-stone-light block mb-1 uppercase tracking-wider">EUR (æ­å…ƒ)</label>
                        <input type="number" v-model="currencyInput" @input="calculateCurrency" class="w-full bg-white/20 border border-white/30 rounded-xl px-3 py-2.5 text-white placeholder-white/50 focus:outline-none focus:bg-white/30 text-lg font-bold" placeholder="â‚¬">
                    </div>
                    <i class="fa-solid fa-arrow-right-arrow-left text-stone-light mt-5"></i>
                    <div class="flex-1">
                        <label class="text-[10px] text-stone-light block mb-1 uppercase tracking-wider">TWD (å°å¹£)</label>
                        <div class="w-full bg-white/10 rounded-xl px-3 py-2.5 text-white text-lg font-bold border border-transparent">
                            $ {{ currencyResult }}
                        </div>
                    </div>
                </div>
                <p class="text-[10px] text-stone-light/70 mt-3 text-right relative z-10">åŒ¯ç‡åŸºæº–: {{ EXCHANGE_RATE_EUR }} (æ¯æ—¥åŒ¯ç‡è«‹è¦‹è¡Œç¨‹é )</p>
            </div>
            
            <div class="bg-white rounded-3xl p-5 card-shadow">
                <h3 class="font-bold text-slate-800 mb-3 border-b border-slate-100 pb-2"><i class="fa-solid fa-plane-departure text-blue-500 mr-2"></i> èˆªç­è³‡è¨Š</h3>
                <div class="space-y-4">
                    <div class="bg-stone-light/20 rounded-xl p-3 border border-stone-light/50">
                        <div class="flex justify-between text-sm font-bold text-colosseum-dark mb-1">
                            <span>PVG ä¸Šæµ·æµ¦æ±</span>
                            <i class="fa-solid fa-plane text-xs"></i>
                            <span>MXP ç±³è˜­é¦¬çˆ¾å½­è–©</span>
                        </div>
                        <div class="flex justify-between text-xs text-slate-500">
                            <span>01:45 (12/14)</span>
                            <span>CA967</span>
                            <span>07:15 (12/14)</span>
                        </div>
                    </div>
                    <div class="bg-orange-50 rounded-xl p-3 border border-orange-100">
                        <div class="flex justify-between text-sm font-bold text-orange-800 mb-1">
                            <span>FCO ç¾…é¦¬è²çƒç±³å¥‡è«¾</span>
                            <i class="fa-solid fa-plane text-xs"></i>
                            <span>TPE å°åŒ—</span>
                        </div>
                        <div class="flex justify-between text-xs text-slate-500">
                            <span>15:00 (12/21)</span>
                            <span>TBC å¾…å®š</span>
                            <span>10:30 (12/22)</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-3xl p-6 card-shadow">
                <h3 class="font-bold text-slate-800 mb-4 border-b border-slate-100 pb-3"><i class="fa-solid fa-hotel text-indigo-500 mr-2"></i> ä½å®¿è³‡è¨Š</h3>
                <ul class="space-y-5">
                    <li v-for="hotel in hotels" class="border-b last:border-0 pb-4 last:pb-0">
                        <div class="flex justify-between items-start group">
                            <div class="flex-1">
                                <span class="font-bold block text-slate-700 text-lg">{{ hotel.name }}</span>
                                <span class="text-xs text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full inline-block mt-1">{{ hotel.date }}</span>
                            </div>
                            <button @click="openMap(hotel.name)" class="w-8 h-8 rounded-full bg-indigo-50/50 text-colosseum-dark flex items-center justify-center group-hover:bg-colosseum-dark group-hover:text-white transition-all"><i class="fa-solid fa-location-arrow text-xs"></i></button>
                        </div>
                        <div class="text-sm text-slate-500 mt-2 space-y-1">
                            <p class="flex items-center"><i class="fa-solid fa-phone w-4 text-center mr-2 text-slate-300"></i> <a :href="'tel:' + hotel.phone" class="hover:text-colosseum-dark">{{ hotel.phone }}</a></p>
                            <p class="flex items-start"><i class="fa-solid fa-map-pin w-4 text-center mr-2 mt-1 text-slate-300"></i> {{ hotel.address }}</p>
                        </div>
                    </li>
                </ul>
            </div>

            <!-- ç·Šæ€¥è¯çµ¡è³‡è¨Š -->
            <div class="bg-red-50 rounded-3xl p-6 border border-red-100">
                <h3 class="font-bold text-red-800 mb-4"><i class="fa-solid fa-kit-medical mr-2"></i> ç·Šæ€¥è¯çµ¡ (ç¾©å¤§åˆ©)</h3>
                <div class="grid grid-cols-3 gap-4 text-center text-xs">
                    <a href="tel:113" class="bg-white py-3 rounded-xl shadow-sm text-red-600 font-bold block border border-red-100 hover:bg-red-600 hover:text-white transition-all">
                        <i class="fa-solid fa-user-shield mr-1"></i> è­¦å¯Ÿ 113
                    </a>
                    <a href="tel:118" class="bg-white py-3 rounded-xl shadow-sm text-red-600 font-bold block border border-red-100 hover:bg-red-600 hover:text-white transition-all">
                        <i class="fa-solid fa-truck-medical mr-1"></i> æ•‘è­· 118
                    </a>
                    <a href="tel:112" class="bg-white py-3 rounded-xl shadow-sm text-red-600 font-bold block border border-red-100 hover:bg-red-600 hover:text-white transition-all">
                        <i class="fa-solid fa-phone mr-1"></i> æ­ç›Ÿé€šç”¨ 112
                    </a>
                </div>
            </div>
        </div>

        <!-- è³¼ç‰©é  -->
        <div v-if="currentTab === 'shopping'" class="animate-fade-in">
            <div class="grid grid-cols-2 gap-4">
                <div v-for="(item, idx) in shoppingList" :key="idx" class="bg-white rounded-2xl p-3 card-shadow relative group">
                    <div class="aspect-square bg-slate-50 rounded-xl mb-3 overflow-hidden relative border border-slate-100">
                        <!-- åœ–ç‰‡ Placeholder -->
                        <img v-if="item.image" :src="item.image" class="w-full h-full object-cover">
                        <div v-else class="w-full h-full flex items-center justify-center text-slate-300">
                            <i class="fa-solid fa-bag-shopping text-3xl"></i>
                        </div>
                        <button @click="removeShoppingItem(idx)" class="absolute top-2 right-2 bg-black/60 text-white rounded-full w-7 h-7 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity">
                            <i class="fa-solid fa-xmark"></i>
                        </button>
                    </div>
                    <p class="font-bold text-sm text-slate-800 truncate px-1">{{ item.name }}</p>
                </div>
                
                <div v-if="shoppingList.length === 0" class="col-span-2 text-center py-16 text-slate-300">
                    <i class="fa-solid fa-bag-shopping text-5xl mb-3 text-slate-200"></i>
                    <p class="text-sm">è³¼ç‰©æ¸…å–®ç©ºç™½<br>è«‹é»æ“Šå³ä¸‹è§’æ–°å¢</p>
                </div>
            </div>
        </div>

        <!-- èŠ±è²»é  -->
        <div v-if="currentTab === 'expenses'" class="animate-fade-in">
             <!-- æ›¿æ›ç‚ºç¾…é¦¬è‰²ç³»æ¼¸è®Š -->
            <div class="expenses-banner text-white rounded-3xl p-8 mb-6 relative overflow-hidden">
                
                <div class="absolute -right-10 -top-10 bg-white/10 w-48 h-48 rounded-full blur-3xl"></div>
                <div class="absolute -left-10 -bottom-10 bg-stone-light/20 w-40 h-40 rounded-full blur-2xl"></div>
                <p class="text-sm text-stone-light/80 mb-2 relative z-10">ç›®å‰ç¸½èŠ±è²» (EUR)</p>
                <h2 class="text-5xl font-bold relative z-10 tracking-tight">â‚¬ {{ formatNumber(totalExpensesEUR) }}</h2>
                <p class="text-sm text-right mt-2 opacity-80 
relative z-10">ç´„ NT$ {{ formatNumber(totalExpensesTWD) }} (åŒ¯ç‡ä»¥ {{ EXCHANGE_RATE_EUR }} è¨ˆç®—)</p>
            </div>

            <div class="bg-white rounded-t-3xl min-h-[500px] p-6 shadow-[0_-10px_40px_rgba(0,0,0,0.03)] -mx-4 px-8">
                <h3 class="font-bold text-slate-800 mb-5 flex items-center">
                    <i class="fa-solid fa-receipt text-slate-300 mr-2"></i>æ”¯å‡ºç´€éŒ„
                </h3>
                <div class="space-y-5">
                    <div v-for="(exp, idx) in expenses" :key="idx" class="flex items-center justify-between border-b border-slate-50 pb-4 last:border-0">
                        <div class="flex items-center">
                            
                            <div class="expense-category-tag mr-4" :class="[getCategoryColor(exp.category), 'text-white']">
                                {{ getCategoryLabel(exp.category) }}
                            </div>
                            <div>
                                <p class="font-bold text-slate-700 text-sm mb-0.5">{{ exp.name }}</p>
                                <p class="text-[10px] text-slate-400 uppercase tracking-wide">{{ exp.date }} Â· {{ exp.payment === 'card' ?
'ä¿¡ç”¨å¡' : 'ç¾é‡‘' }}</p>
                            </div>
                        </div>
                        <div class="text-right flex items-center">
                            <p class="font-bold text-slate-700">â‚¬{{ formatNumber(exp.amount) }}</p>
                            <button @click="removeExpense(idx)" class="w-5 h-5 ml-3 text-red-300 hover:text-red-500 transition-colors flex items-center justify-center">
                                <i class="fa-solid fa-xmark text-lg"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI å·¥å…·é é¢ -->
        <div v-if="currentTab === 'ai-tools'" class="animate-fade-in space-y-6">
            <div class="bg-white p-6 rounded-3xl shadow-lg border border-ai-pink/20">
                <h2 class="text-xl font-bold mb-4 text-ai-pink border-b border-pink-100 pb-3 flex items-center">
                    <i class="fa-solid fa-language w-5 h-5 mr-2"></i>
                    ç¾©å¤§åˆ©æ–‡å³æ™‚ç¿»è­¯ (Gemini)
                </h2>
                <div class="space-y-3">
                    <input type="text" v-model="translateInput" :disabled="isTranslating"
                           placeholder="è¼¸å…¥ä¸­æ–‡æˆ–ç¾©å¤§åˆ©æ–‡ä¾†ç¿»è­¯ (ä¾‹å¦‚ï¼šè«‹å•æ´—æ‰‹é–“åœ¨å“ªè£¡ï¼Ÿ)" 
                           class="w-full rounded-xl border-gray-300 shadow-sm p-3 border focus:border-ai-pink focus:ring-ai-pink">
                    <button @click="translatePhrase" :disabled="isTranslating || !translateInput.trim()"
                            class="w-full flex items-center justify-center px-4 py-3 border border-transparent text-base font-medium rounded-xl shadow-md text-white bg-ai-pink hover:bg-ai-pink/80 transition duration-150 disabled:bg-pink-300">
                        <i :class="isTranslating ? 'fa-solid fa-spinner animate-spin' : 'fa-solid fa-comment-dots'" class="w-5 h-5 mr-2"></i>
                        {{ isTranslating ? 'ç¿»è­¯ä¸­...' : 'ç«‹å³ç¿»è­¯' }}
                    </button>
                </div>
                <div v-if="translationOutput" class="mt-4 p-3 bg-ai-light-pink text-slate-800 rounded-xl text-sm">
                    <h5 class="font-bold text-sm text-ai-pink mb-1">ç¿»è­¯çµæœï¼š</h5>
                    <div class="whitespace-pre-wrap" v-html="formatMarkdown(translationOutput)"></div>
                </div>
                <div v-else-if="translationError" class="mt-4 p-3 bg-red-100 text-red-700 rounded-xl text-sm">
                     <i class="fa-solid fa-triangle-exclamation mr-1"></i> {{ translationError }}
                </div>
            </div>
            
             <div class="bg-white p-6 rounded-3xl shadow-lg border border-ai-pink/20">
                <h2 class="text-xl font-bold mb-4 text-ai-pink border-b border-pink-100 pb-3 flex items-center">
                    <i class="fa-solid fa-circle-question w-5 h-5 mr-2"></i>
                    æ—…éŠå•ç­” (Gemini Search)
                </h2>
                <div class="space-y-3">
                    <input type="text" v-model="qnaInput" :disabled="isQNALoading"
                           placeholder="è¼¸å…¥ä½ çš„ç¾©å¤§åˆ©å•é¡Œ (ä¾‹å¦‚ï¼šç¾…é¦¬ç«¶æŠ€å ´çš„æ­·å²ï¼Ÿ)" 
                           class="w-full rounded-xl border-gray-300 shadow-sm p-3 border focus:border-ai-pink focus:ring-ai-pink">
                    <button @click="searchQNA" :disabled="isQNALoading || !qnaInput.trim()"
                            class="w-full flex items-center justify-center px-4 py-3 border border-transparent text-base font-medium rounded-xl shadow-md text-white bg-colosseum-dark hover:bg-colosseum-dark/80 transition duration-150 disabled:bg-slate-400">
                        <i :class="isQNALoading ? 'fa-solid fa-spinner animate-spin' : 'fa-solid fa-magnifying-glass'" class="w-5 h-5 mr-2"></i>
                        {{ isQNALoading ? 'æœå°‹ä¸­...' : 'æŸ¥æ‰¾ç­”æ¡ˆ' }}
                    </button>
                </div>
                <div v-if="qnaOutput.text" class="mt-4 p-3 bg-slate-50 text-slate-800 rounded-xl text-sm">
                    <h5 class="font-bold text-sm text-colosseum-dark mb-1">AI æŸ¥æ‰¾çµæœï¼š</h5>
                    <div class="whitespace-pre-wrap" v-html="formatMarkdown(qnaOutput.text)"></div>
                     <div v-if="qnaOutput.sources.length" class="mt-3 pt-2 border-t border-slate-200">
                        <p class="text-xs text-slate-500 font-semibold mb-1">åƒè€ƒä¾†æº:</p>
                        <div class="space-y-1">
                            <a v-for="(source, sIdx) in qnaOutput.sources" :key="sIdx" 
                               :href="source.uri" target="_blank" 
                               class="text-colosseum-dark hover:underline text-xs block truncate" 
                               :title="source.title || 'é»æ“ŠæŸ¥çœ‹ä¾†æº'">
                                {{ sIdx + 1 }}. {{ source.title || 'ç„¡æ¨™é¡Œ' }}
                            </a>
                        </div>
                    </div>
                </div>
                 <div v-else-if="qnaError" class="mt-4 p-3 bg-red-100 text-red-700 rounded-xl text-sm">
                     <i class="fa-solid fa-triangle-exclamation mr-1"></i> {{ qnaError }}
                </div>
            </div>
        </div>
        <!-- End AI Tools Page -->

    </main>

 
    <button v-if="currentTab === 'itinerary' || currentTab === 'shopping' || currentTab === 'expenses'" @click="handleAddClick" class="fixed bottom-6 right-6 w-14 h-14 bg-roman-bronze rounded-full fab-shadow text-colosseum-dark text-2xl flex items-center justify-center hover:scale-110 transition-transform z-40">
        <i class="fa-solid fa-plus"></i>
    </button>

    <div v-if="showShoppingModal" class="fixed inset-0 bg-colosseum-dark/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-5 text-center text-slate-800">æ–°å¢è³¼ç‰©æ¸…å–®</h3>
            <input v-model="newShoppingItem.name" type="text" placeholder="å•†å“åç¨±" class="w-full 
bg-slate-50 border-none rounded-xl p-4 mb-4 focus:ring-2 focus:ring-colosseum-dark text-sm">
            <div class="relative mb-6">
                <input type="file" @change="handleImageUpload" class="hidden" id="fileInput">
                <label for="fileInput" class="w-full h-36 bg-slate-50 border-2 border-dashed border-slate-200 rounded-xl flex items-center justify-center cursor-pointer text-slate-400 hover:bg-slate-100 hover:border-border-slate-300 transition-all">
                    <span v-if="!newShoppingItem.image" class="flex flex-col items-center text-xs">
                        <i class="fa-solid fa-camera text-2xl mb-2"></i> ä¸Šå‚³ç…§ç‰‡
                    </span>
                    <img v-else :src="newShoppingItem.image" class="h-full w-full object-contain rounded-xl">
                </label>
           
            </div>
            <div class="flex space-x-3">
                <button @click="showShoppingModal = false" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">å–æ¶ˆ</button>
                <button @click="addShoppingItem" class="flex-1 py-3 rounded-xl bg-colosseum-dark text-white font-bold text-sm shadow-lg shadow-colosseum-dark/30">æ–°å¢</button>
            </div>
        </div>
    </div>
    
    <div 
v-if="showExpenseModal" class="fixed inset-0 bg-colosseum-dark/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl">
            <h3 class="font-bold text-lg mb-5 text-center text-slate-800">è¨˜ä¸€ç­†</h3>
            <div class="grid grid-cols-2 gap-3 mb-4">
                <input v-model="newExpense.date" type="date" class="bg-slate-50 rounded-xl p-3 text-sm text-slate-600 outline-none">
                <select v-model="newExpense.category" class="bg-slate-50 
rounded-xl p-3 text-sm text-slate-600 outline-none">
                    <option value="food">é£²é£Ÿ</option>
                    <option value="shopping">è³¼ç‰©</option>
                    <option value="transport">äº¤é€š</option>
                    <option value="stay">ä½å®¿</option>
            
                    <option value="ticket">é–€ç¥¨</option>
                    <option value="other">å…¶ä»–</option>
                </select>
            </div>
            <input v-model="newExpense.name" placeholder="åç¨± (å¦‚: ç¾©å¤§åˆ©éºµ)" class="w-full bg-slate-50 rounded-xl p-4 mb-4 text-sm outline-none focus:ring-2 focus:ring-roman-bronze">
            <div class="relative mb-4">
    
                <span class="absolute left-4 top-4 text-slate-400 font-bold">â‚¬</span>
                <input v-model.number="newExpense.amount" type="number" placeholder="é‡‘é¡" class="w-full bg-slate-50 rounded-xl p-4 pl-8 text-sm outline-none focus:ring-2 focus:ring-roman-bronze font-bold text-lg">
            </div>
            <div class="flex space-x-3 mb-6">
                <button @click="newExpense.payment='cash'" :class="newExpense.payment==='cash' ? 'bg-colosseum-dark text-white' : 'bg-slate-100 text-slate-500'" class="flex-1 py-3 rounded-xl text-sm transition-colors"><i class="fa-solid fa-coins mr-1"></i> ç¾é‡‘</button>
                <button @click="newExpense.payment='card'" :class="newExpense.payment==='card' ? 'bg-colosseum-dark text-white' : 'bg-slate-100 text-slate-500'" class="flex-1 py-3 rounded-xl text-sm transition-colors"><i class="fa-solid fa-credit-card mr-1"></i> ä¿¡ç”¨å¡</button>
            </div>
            <div class="flex space-x-3">
                <button @click="showExpenseModal = false" class="flex-1 py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">å–æ¶ˆ</button>
                <button @click="addExpense" class="flex-1 py-3 rounded-xl bg-roman-bronze text-colosseum-dark font-bold text-sm shadow-lg shadow-roman-bronze/30">å„²å­˜</button>
            </div>
        </div>
    </div>
    
    <div v-if="showItineraryModal" class="fixed inset-0 bg-colosseum-dark/40 z-50 flex items-center justify-center p-6 backdrop-blur-sm animate-fade-in">
        <div class="bg-white rounded-3xl w-full max-w-sm p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <h3 class="font-bold text-lg mb-5 text-center text-slate-800">{{ isEditMode ? 'ç·¨è¼¯è¡Œç¨‹' : 'æ–°å¢è¡Œç¨‹' }}</h3>
            <div class="space-y-3">
                <select v-model="newItinerary.category" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none">
                    <option value="sightseeing">æ™¯é»</option>
                    <option value="food">é£²é£Ÿ</option>
                    <option value="shopping">è³¼ç‰©</option>
                    <option value="accommodation">ä½å®¿</option>
                    <option value="flight">èˆªç­</option>
                    <option value="transport">äº¤é€š</option>
                    <option value="ticket">é–€ç¥¨</option>
                    <option value="other">å…¶ä»–</option>
                </select>
                <input v-model="newItinerary.name" placeholder="åç¨±" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-colosseum-dark">
                <input v-model="newItinerary.address" placeholder="åœ°å€/åœ°é» (Google Map æœå°‹ç”¨)" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-colosseum-dark">
                <div class="grid grid-cols-2 gap-3">
                    <input v-model="newItinerary.startTime" type="text" placeholder="æ™‚é–“ (e.g. 09:30)" class="bg-slate-50 rounded-xl p-3 text-sm outline-none">
                    <select v-model="newItinerary.transportType" class="bg-slate-50 rounded-xl p-3 text-sm outline-none">
                        <option value="walk">æ­¥è¡Œ</option>
                        <option value="car">è‡ªé§•</option>
                        <option value="bus">å·´å£«</option>
                        <option value="public">åœ°éµ/JR</option>
                        <option value="flight">é£›æ©Ÿ</option>
                        <option value="other">å…¶ä»–</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <input v-model="newItinerary.travelTime" type="text" placeholder="è»Šç¨‹/ç§»å‹•æ™‚é–“" class="bg-slate-50 rounded-xl p-3 text-sm outline-none">
                    <input v-model="newItinerary.hours" type="text" placeholder="ç‡Ÿæ¥­æ™‚é–“" class="bg-slate-50 rounded-xl p-3 text-sm outline-none">
                </div>
                <input v-model="newItinerary.price" type="text" placeholder="é–€ç¥¨/è²»ç”¨" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-colosseum-dark">
                <textarea v-model="newItinerary.note" placeholder="å‚™è¨»/ç´°ç¯€" rows="3" class="w-full bg-slate-50 rounded-xl p-3 text-sm outline-none focus:ring-2 focus:ring-colosseum-dark"></textarea>
            </div>
            <div class="flex space-x-3 mt-6">
                <button @click="showItineraryModal = false; isEditMode = false" :class="isEditMode ? 'w-1/3' : 'flex-1'" class="py-3 rounded-xl bg-slate-100 text-slate-500 font-bold text-sm">å–æ¶ˆ</button>
                
                <button v-if="isEditMode" @click="removeItineraryItem(newItinerary.id)" class="w-1/3 py-3 rounded-xl bg-red-100 text-red-600 font-bold text-sm hover:bg-red-200 transition-colors">
                    <i class="fa-solid fa-trash-can mr-1"></i> åˆªé™¤
                </button>
                
                <button @click="saveItineraryItem" :class="isEditMode ? 'w-1/3' : 'flex-1'" class="py-3 rounded-xl bg-colosseum-dark text-white font-bold text-sm shadow-lg shadow-colosseum-dark/30">{{ isEditMode ? 'å„²å­˜ä¿®æ”¹' : 'æ–°å¢è¡Œç¨‹' }}</button>
            </div>
        </div>
    </div>


</div> <script type="module">
    const { createApp, ref, computed, onMounted } = Vue

    createApp({
        setup() {
            // Global variable for Gemini API Key (will be provided by the environment)
            const API_KEY = ""; 
            const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
            const EXCHANGE_RATE_EUR = 35.0; // æ­å…ƒ (EUR) å…Œ å°å¹£ (TWD) åŒ¯ç‡ - åŸºæº–å€¼
            const EXCHANGE_RATE = EXCHANGE_RATE_EUR;

            // æ¨™ç±¤é¡è‰²èˆ‡åœ–ç¤ºå®šç¾©
            const CATEGORY_MAP = {
                sightseeing: { color: 'bg-green-600', icon: 'fa-solid fa-camera' },
                food: { color: 'bg-red-600', icon: 'fa-solid fa-utensils' },
                shopping: { color: 'bg-indigo-600', icon: 'fa-solid fa-bag-shopping' },
                accommodation: { color: 'bg-purple-600', icon: 'fa-solid fa-bed' },
                flight: { color: 'bg-blue-600', icon: 'fa-solid fa-plane-departure' },
                transport: { color: 'bg-orange-600', icon: 'fa-solid fa-train-subway' },
                ticket: { color: 'bg-cyan-600', icon: 'fa-solid fa-ticket' },
                other: { color: 'bg-slate-600', icon: 'fa-solid fa-circle-info' },
                stay: { color: 'bg-purple-600', icon: 'fa-solid fa-hotel' }, 
            };
            const CATEGORY_LABEL_MAP = {
                sightseeing: 'æ™¯é»', food: 'é£²é£Ÿ', shopping: 'è³¼ç‰©', accommodation: 'ä½å®¿', flight: 'èˆªç­', transport: 'äº¤é€š', ticket: 'é–€ç¥¨', other: 'å…¶ä»–', stay: 'ä½å®¿'
            };

            // ç•¶å‰é é¢
            const currentTab = ref('itinerary');

            // --- è³‡æ–™å®šç¾©ï¼šç¾©å¤§åˆ©è¡Œç¨‹ 12/14-12/21 (æœªè®Šæ›´) ---
            
            const dates = ref([
                { date: '12/14', weekday: 'æ—¥', hasCar: false, tollFee: 0 }, // ç±³è˜­
                { date: '12/15', weekday: 'ä¸€', hasCar: false, tollFee: 0 }, // ç±³è˜­
                { date: '12/16', weekday: 'äºŒ', hasCar: false, tollFee: 0 }, // ç±³è˜­â†’å¨å°¼æ–¯
                { date: '12/17', weekday: 'ä¸‰', hasCar: false, tollFee: 0 }, // å¨å°¼æ–¯â†’ä½›ç¾…å€«æ–¯
                { date: '12/18', weekday: 'å››', hasCar: false, tollFee: 0 }, // ä½›ç¾…å€«æ–¯
                { date: '12/19', weekday: 'äº”', hasCar: false, tollFee: 0 }, // ä½›ç¾…å€«æ–¯â†’ç¾…é¦¬
                { date: '12/20', weekday: 'å…­', hasCar: false, tollFee: 0 }, // ç¾…é¦¬/æ¢µè’‚å²¡
                { date: '12/21', weekday: 'æ—¥', hasCar: false, tollFee: 0 }, // ç¾…é¦¬/è¿”ç¨‹
            ]);

            const hotels = ref([
                { name: 'ç±³è˜­ï¼šç±³è˜­æ™‚å°šè¡—å€é£¯åº—', date: '12/14 - 12/16 (2æ™š)', phone: '+39-02-123456', address: 'Via della Spiga, Milano (ç±³è˜­)' },
                { name: 'ä½›ç¾…å€«æ–¯ï¼šHotel Paris', date: '12/17 - 12/18 (2æ™š)', phone: '+39-055-789012', address: 'Via Dei Benci 12, Firenze (ä½›ç¾…å€«æ–¯)' },
                { name: 'ç¾…é¦¬ï¼šStarhotels Metropole', date: '12/19 - 12/21 (2æ™š)', phone: '+39-06-345678', address: 'Via Principe Amedeo 3, Roma (ç¾…é¦¬)' },
            ]);
            
            // è¡Œç¨‹æ•¸æ“š (æœªè®Šæ›´)
            const itineraryData = ref([
                // Day 1: 12/14 (æ—¥) ç±³è˜­
                [
                    { id: 101, name: 'æ©Ÿå ´æŠµé”ï¼šç±³è˜­é¦¬çˆ¾å½­è–©æ©Ÿå ´ (MXP)', category: 'flight', startTime: '07:15', address: 'ç±³è˜­é¦¬çˆ¾å½­è–©æ©Ÿå ´', note: 'CA967 èˆªç­ã€‚æº–å‚™æ­ç«è»Š/å·´å£«é€²åŸã€‚', hours: null, price: null, transportType: 'flight', travelTime: null, isNoteExpanded: false },
                    { id: 102, name: 'ç±³è˜­ä¸­å¤®è»Šç«™-è¡Œæå¯„å­˜', category: 'other', startTime: '10:30', address: 'ç±³è˜­ä¸­å¤®è»Šç«™', note: 'ä½¿ç”¨ Radical Storage æˆ–è»Šç«™å„²ç‰©æ«ƒ (â‚¬10)', hours: null, price: 'â‚¬10', transportType: 'public', travelTime: '1h', isNoteExpanded: false },
                    { id: 103, name: 'æ–¯ç¦çˆ¾æ‰å¤å ¡ & æ£®çš®å¥§å…§å…¬åœ’', category: 'sightseeing', startTime: '11:30', address: 'Castello Sforzesco', note: 'å¤å ¡å¤–éƒ¨å…è²»åƒè§€ï¼Œåšç‰©é¤¨éœ€é–€ç¥¨ã€‚', hours: '07:00â€“19:30', price: 'â‚¬5 (åšç‰©é¤¨)', transportType: 'public', travelTime: '30m', isNoteExpanded: false },
                    { id: 104, name: 'æ©å® è–æ¯æ•™å ‚-æœ€å¾Œçš„æ™šé¤', category: 'sightseeing', startTime: '15:00', address: 'Santa Maria delle Grazie', note: 'éœ€æå‰é ç´„é–€ç¥¨ï¼Œç¢ºèªæ™‚é–“ã€‚', hours: 'éœ€é ç´„', price: 'ç´„ â‚¬15', transportType: 'walk', travelTime: '20m', isNoteExpanded: false },
                    { id: 105, name: 'æ™šé¤ï¼šç±³è˜­ç•¶åœ°ç‰¹è‰²é¤å»³', category: 'food', startTime: '19:00', address: 'Duomo å»£å ´å‘¨é‚Š', note: 'ç±³è˜­ç‡‰é£¯æˆ–ç±³è˜­ç‚¸è‚‰æ’ã€‚', hours: null, price: null, transportType: 'public', travelTime: '20m', isNoteExpanded: false },
                    { id: 106, name: 'é£¯åº— Check-in', category: 'accommodation', startTime: '21:00', address: 'ç±³è˜­æ™‚å°šè¡—å€é£¯åº—', note: 'çµæŸç¬¬ä¸€å¤©è¡Œç¨‹', hours: null, price: null, transportType: 'public', travelTime: '30m', isNoteExpanded: false },
                ],
                // Day 2: 12/15 (ä¸€) ç±³è˜­
                [
                    { id: 201, name: 'ç±³è˜­å¤§æ•™å ‚ & ç™»é ‚', category: 'sightseeing', startTime: '09:00', address: 'Duomo di Milano', note: 'å»ºè­°ä¸€æ—©å‰å¾€ç™»é ‚ï¼Œé¿é–‹äººæ½®ã€‚', hours: '09:00â€“19:00', price: 'ç´„ â‚¬16', transportType: 'walk', travelTime: '10m', isNoteExpanded: false },
                    { id: 202, name: 'åŸƒé¦¬åŠªåŸƒèŠäºŒä¸–æ‹±å»Š (è³¼ç‰©)', category: 'shopping', startTime: '11:30', address: 'Galleria Vittorio Emanuele II', note: 'æ¬£è³è¯éº—å»ºç¯‰èˆ‡ç²¾å“åº—ï¼Œå°‹æ‰¾ Kikoã€‚', hours: null, price: null, transportType: 'walk', travelTime: '5m', isNoteExpanded: false },
                    { id: 203, name: 'åˆé¤ï¼šä¸‰æ˜æ²»æˆ–æ¯”è–©', category: 'food', startTime: '~13:00', address: 'æ‹±å»Šé™„è¿‘å¿«é¤åº—', note: 'å¿«é€Ÿè§£æ±ºåˆé¤ï¼Œç¹¼çºŒä¸‹åˆè¡Œç¨‹ã€‚', hours: null, price: null, transportType: 'walk', travelTime: '0m', isNoteExpanded: false },
                    { id: 204, name: 'è–è²ç´è¿ªè«¾éª¸éª¨æ•™å ‚', category: 'sightseeing', startTime: '14:30', address: 'San Bernardino alle Ossa', note: 'ç¨ç‰¹çš„éª¨é ­è£é£¾ç¦®æ‹œå ‚ã€‚', hours: '13:00-17:30', price: 'å…è²»', transportType: 'public', travelTime: '15m', isNoteExpanded: false },
                    { id: 205, name: 'å¸ƒé›·æ‹‰ç•«å»Š', category: 'sightseeing', startTime: '16:00', address: 'Pinacoteca di Brera', note: 'ç±³è˜­é‡è¦çš„ç¾è¡“é¤¨ï¼Œæ¬£è³ç¾©å¤§åˆ©æ–‡è—å¾©èˆˆä½œå“ã€‚', hours: '10:00â€“18:00', price: 'ç´„ â‚¬15', transportType: 'public', travelTime: '20m', isNoteExpanded: false },
                    { id: 206, name: 'æ™šé¤ï¼šæ™‚å°šå››é‚Šå½¢é™„è¿‘é«˜ç´šé¤å»³', category: 'food', startTime: '19:30', address: 'Via Montenapoleone é™„è¿‘', note: 'é«”é©—ç±³è˜­çš„æ™‚å°šèˆ‡ç¾é£Ÿã€‚', hours: null, price: null, transportType: 'walk', travelTime: '25m', isNoteExpanded: false },
                ],
                // Day 3: 12/16 (äºŒ) ç±³è˜­ â†’ å¨å°¼æ–¯
                [
                    { id: 301, name: 'é€€æˆ¿ä¸¦å‰å¾€è»Šç«™', category: 'accommodation', startTime: '08:00', address: 'ç±³è˜­æ™‚å°šè¡—å€é£¯åº—', note: 'æ­ä¹˜ç«è»Šå‰å¾€å¨å°¼æ–¯ã€‚', hours: null, price: null, transportType: 'public', travelTime: '20m', isNoteExpanded: false },
                    { id: 302, name: 'é«˜éµï¼šç±³è˜­ä¸­å¤®è»Šç«™ â†’ å¨å°¼æ–¯ Mestre', category: 'transport', startTime: '09:00', address: 'å¨å°¼æ–¯ Mestre è»Šç«™', note: 'é«˜é€Ÿç«è»Šï¼Œç´„ 2.5 å°æ™‚ã€‚', hours: null, price: 'ç´„ â‚¬30', transportType: 'public', travelTime: '2h30m', isNoteExpanded: false },
                    { id: 303, name: 'å¨å°¼æ–¯ Mestre ä½å®¿ Check-in', category: 'accommodation', startTime: '12:00', address: 'å¨å°¼æ–¯ Mestre', note: 'æ”¾ä¸‹è¡Œæã€‚', hours: null, price: null, transportType: 'walk', travelTime: '10m', isNoteExpanded: false },
                    { id: 304, name: 'åˆé¤ï¼šMestre æˆ–ä¸»å³¶é€”ä¸­', category: 'food', startTime: '13:00', address: 'å¨å°¼æ–¯ Mestre è»Šç«™é™„è¿‘', note: 'ç°¡é¤ã€‚', hours: null, price: null, transportType: 'walk', travelTime: '0m', isNoteExpanded: false },
                    { id: 305, name: 'æ°´ä¸Šå·´å£«å‰å¾€ä¸»å³¶', category: 'transport', startTime: '14:30', address: 'ç¾…é¦¬å»£å ´ (Piazzale Roma)', note: 'è³¼è²·æ°´ä¸Šå·´å£«ç¥¨ã€‚', hours: null, price: 'ç´„ â‚¬7.5', transportType: 'public', travelTime: '30m', isNoteExpanded: false },
                    { id: 306, name: 'è–é¦¬å¯å»£å ´ & é˜æ¨“', category: 'sightseeing', startTime: '15:30', address: 'Piazza San Marco', note: 'ç™»é ‚é˜æ¨“ä¿¯ç°å¨å°¼æ–¯ï¼ˆéœ€é–€ç¥¨ï¼‰ã€‚', hours: null, price: 'ç´„ â‚¬10', transportType: 'public', travelTime: '10m', isNoteExpanded: false },
                    { id: 307, name: 'ç¸½ç£å®®èˆ‡å˜†æ¯æ©‹ (å¤–è§€)', category: 'sightseeing', startTime: '17:00', address: 'Palazzo Ducale', note: 'ç¸½ç£å®®å…§éƒ¨å¯é¸ï¼Œå¤–è§€èˆ‡å˜†æ¯æ©‹åˆå½±ã€‚', hours: null, price: null, transportType: 'walk', travelTime: '5m', isNoteExpanded: false },
                    { id: 308, name: 'æ™šé¤ï¼šRistorante Vecio Fritolin', category: 'food', startTime: '19:30', address: 'å¨å°¼æ–¯ä¸»å³¶', note: 'å¨å°¼æ–¯ç‰¹è‰²æµ·é®®é¤é¤¨ã€‚', hours: null, price: null, transportType: 'walk', travelTime: '20m', isNoteExpanded: false },
                ],
                // Day 4: 12/17 (ä¸‰) å¨å°¼æ–¯ â†’ ä½›ç¾…å€«æ–¯
                [
                    { id: 401, name: 'é‡Œäºæ‰˜æ©‹èˆ‡å¸‚å ´', category: 'sightseeing', startTime: '09:00', address: 'Ponte di Rialto', note: 'æ¸…æ™¨å¸‚å ´è¼ƒç†±é¬§ï¼Œæ¬£è³å¤§é‹æ²³ã€‚', hours: null, price: null, transportType: 'public', travelTime: '20m', isNoteExpanded: false },
                    { id: 402, name: 'è²¢å¤šæ‹‰é«”é©— (è‡ªé¸)', category: 'other', startTime: '10:30', address: 'å¤§é‹æ²³ç¢¼é ­', note: 'é«”é©—å‚³çµ±æ°´ä¸Šäº¤é€šå·¥å…·ã€‚', hours: null, price: 'ç´„ â‚¬80/èˆ¹', transportType: 'walk', travelTime: '10m', isNoteExpanded: false },
                    { id: 403, name: 'åˆé¤ï¼šå¢¨é­šéºµ/æµ·é®®ç¾©å¤§åˆ©éºµ', category: 'food', startTime: '12:30', address: 'é‡Œäºæ‰˜æ©‹é™„è¿‘', note: 'äº«ç”¨å¨å°¼æ–¯ç‰¹è‰²æ–™ç†ã€‚', hours: null, price: null, transportType: 'walk', travelTime: '10m', isNoteExpanded: false },
                    { id: 404, name: 'é«˜éµï¼šå¨å°¼æ–¯ S. Lucia â†’ ä½›ç¾…å€«æ–¯ S. M. N.', category: 'transport', startTime: '14:00', address: 'ä½›ç¾…å€«æ–¯æ–°è–æ¯ç‘ªåˆ©äºè»Šç«™', note: 'ç«è»Šå‰å¾€ä½›ç¾…å€«æ–¯ã€‚', hours: null, price: 'ç´„ â‚¬40', transportType: 'public', travelTime: '2h10m', isNoteExpanded: false },
                    { id: 405, name: 'é£¯åº— Check-inï¼šHotel Paris', category: 'accommodation', startTime: '16:30', address: 'Hotel Paris, Florence', note: 'æ”¾ä¸‹è¡Œæã€‚', hours: null, price: null, transportType: 'walk', travelTime: '10m', isNoteExpanded: false },
                    { id: 406, name: 'è–æ¯ç™¾èŠ±å¤§æ•™å ‚å€æ¢è·¯', category: 'sightseeing', startTime: '17:30', address: 'Cattedrale di Santa Maria del Fiore', note: 'ç¢ºèªéš”å¤©ç™»é ‚èˆ‡å…§éƒ¨åƒè§€è·¯ç·šã€‚', hours: null, price: null, transportType: 'walk', travelTime: '15m', isNoteExpanded: false },
                    { id: 407, name: 'æ™šé¤ï¼šä½›ç¾…å€«æ–¯ç‰›æ’', category: 'food', startTime: '19:30', address: 'Trattoria Mario æˆ–å‘¨é‚Šé¤å»³', note: 'T-Bone ä½›ç¾…å€«æ–¯ç‰›æ’ï¼', hours: null, price: null, transportType: 'walk', travelTime: '20m', isNoteExpanded: false },
                ],
                // Day 5: 12/18 (å››) ä½›ç¾…å€«æ–¯
                [
                    { id: 501, name: 'è–æ¯ç™¾èŠ±å¤§æ•™å ‚ç™»é ‚', category: 'sightseeing', startTime: '08:15', address: 'Cattedrale di Santa Maria del Fiore', note: 'ä½¿ç”¨å¥—ç¥¨ï¼ŒæŒ‰é ç´„æ™‚é–“ç™»é ‚ã€‚', hours: null, price: 'å¥—ç¥¨ç´„ â‚¬30', transportType: 'walk', travelTime: '15m', isNoteExpanded: false },
                    { id: 502, name: 'è–è‹¥ç¿°æ´—è€…æ´—ç¦®å ‚', category: 'sightseeing', startTime: '10:00', address: 'Battistero di San Giovanni', note: 'æ¬£è³å¤©å ‚ä¹‹é–€èˆ‡å…§éƒ¨é¦¬è³½å…‹ã€‚', hours: null, price: 'å¥—ç¥¨å·²åŒ…å«', transportType: 'walk', travelTime: '5m', isNoteExpanded: false },
                    { id: 503, name: 'åˆé¤ï¼šä¸­å¤®å¸‚å ´', category: 'food', startTime: '12:30', address: 'Mercato Centrale', note: 'ç¾©å¤§åˆ©é£Ÿç‰©å»£å ´ï¼Œé¸æ“‡å¤šæ¨£ã€‚', hours: null, price: null, transportType: 'walk', travelTime: '15m', isNoteExpanded: false },
                    { id: 504, name: 'çƒè²èŒ²ç¾è¡“é¤¨', category: 'sightseeing', startTime: '14:30', address: 'Galleria degli Uffizi', note: 'éœ€æå‰é ç´„ï¼Œçœ‹æ³¢æåˆ‡åˆ©ã€é”æ–‡è¥¿ç­‰å¤§å¸«ä½œå“ã€‚', hours: '08:15-18:30', price: 'ç´„ â‚¬25', transportType: 'public', travelTime: '20m', isNoteExpanded: false },
                    { id: 505, name: 'è€æ©‹ (Ponte Vecchio) æ•£æ­¥', category: 'sightseeing', startTime: '17:00', address: 'Ponte Vecchio', note: 'æ©‹ä¸Šæœ‰è¨±å¤šç å¯¶åº—ï¼Œé©åˆå‚æ™šæ•£æ­¥ã€‚', hours: null, price: 'å…è²»', transportType: 'walk', travelTime: '10m', isNoteExpanded: false },
                    { id: 506, name: 'ç±³é–‹æœ—åŸºç¾…å»£å ´ (å¤•é™½)', category: 'sightseeing', startTime: '18:30', address: 'Piazzale Michelangelo', note: 'ä¿¯ç°ä½›ç¾…å€«æ–¯å…¨æ™¯çš„æœ€ä½³åœ°é»ï¼Œç­‰å¾…æ—¥è½ã€‚', hours: 'å…¨å¤©', price: 'å…è²»', transportType: 'public', travelTime: '20m', isNoteExpanded: false },
                    { id: 507, name: 'æ™šé¤ï¼šå»£å ´å‘¨é‚Šæˆ–å›å¸‚å€', category: 'food', startTime: '20:00', address: 'ç±³é–‹æœ—åŸºç¾…å»£å ´é™„è¿‘', note: 'æ™šé¤å¾Œè¿”å›é£¯åº—ã€‚', hours: null, price: null, transportType: 'public', travelTime: '20m', isNoteExpanded: false },
                ],
                // Day 6: 12/19 (äº”) ä½›ç¾…å€«æ–¯ â†’ ç¾…é¦¬
                [
                    { id: 601, name: 'é«˜éµï¼šä½›ç¾…å€«æ–¯ S. M. N. â†’ ç¾…é¦¬ Termini', category: 'transport', startTime: '08:00', address: 'ç¾…é¦¬ Termini è»Šç«™', note: 'æ­ä¹˜æ—©ç­ç«è»Šå‰å¾€ç¾…é¦¬ã€‚', hours: null, price: 'ç´„ â‚¬35', transportType: 'public', travelTime: '2h30m', isNoteExpanded: false },
                    { id: 602, name: 'ç¾…é¦¬ Termini é£¯åº— Check-in', category: 'accommodation', startTime: '10:45', address: 'Starhotels Metropole', note: 'æ”¾ä¸‹è¡Œæã€‚', hours: null, price: null, transportType: 'walk', travelTime: '10m', isNoteExpanded: false },
                    { id: 603, name: 'ç¾…é¦¬ç«¶æŠ€å ´èˆ‡å¤ç¾…é¦¬å»£å ´', category: 'sightseeing', startTime: '12:00', address: 'Colosseo', note: 'æå‰é ç´„ï¼Œå«ç¾…é¦¬å»£å ´èˆ‡å¸•æ‹‰ä¸å±±è¯ç¥¨ã€‚', hours: '09:00â€“16:30', price: 'ç´„ â‚¬24', transportType: 'public', travelTime: '20m', isNoteExpanded: false },
                    { id: 604, name: 'åˆé¤ï¼šç«¶æŠ€å ´é™„è¿‘å¿«é¤', category: 'food', startTime: '14:30', address: 'Colosseo é™„è¿‘', note: 'ç°¡é¤ï¼Œç¯€çœæ™‚é–“ã€‚', hours: null, price: null, transportType: 'walk', travelTime: '0m', isNoteExpanded: false },
                    { id: 605, name: 'è–ä¾ç´çˆµå ‚ (é€è¦–å¤©èŠ±æ¿)', category: 'sightseeing', startTime: '16:00', address: 'Chiesa di Santâ€™Ignazio', note: 'æ¬£è³è‘—åçš„é€è¦–å£ç•«ï¼Œæ„Ÿå—éœ‡æ’¼ã€‚', hours: '15:00â€“19:00', price: 'å…è²»', transportType: 'public', travelTime: '15m', isNoteExpanded: false },
                    { id: 606, name: 'è¬ç¥æ®¿ & ç‰¹é›·ç¶­å™´æ³‰ (è¨±é¡˜)', category: 'sightseeing', startTime: '17:30', address: 'Pantheon', note: 'è¬ç¥æ®¿éœ€é–€ç¥¨ (â‚¬5)ï¼Œç‰¹é›·ç¶­å™´æ³‰æ‹ç…§è¨±é¡˜ã€‚', hours: '09:00â€“19:00', price: 'â‚¬5 (è¬ç¥æ®¿)', transportType: 'walk', travelTime: '10m', isNoteExpanded: false },
                    { id: 607, name: 'æ™šé¤ï¼šç¾…é¦¬ç¶“å…¸ç¾©å¤§åˆ©éºµ', category: 'food', startTime: '20:00', address: 'ç´æ²ƒç´å»£å ´é™„è¿‘', note: 'Cacio e Pepe æˆ– Carbonaraã€‚', hours: null, price: null, transportType: 'public', travelTime: '20m', isNoteExpanded: false },
                ],
                // Day 7: 12/20 (å…­) ç¾…é¦¬/æ¢µè’‚å²¡
                [
                    { id: 701, name: 'æ¢µè’‚å²¡åšç‰©é¤¨èˆ‡è¥¿æ–¯æ±€æ•™å ‚', category: 'sightseeing', startTime: '07:30', address: 'Musei Vaticani', note: 'æå‰é ç´„ï¼Œé¿é–‹æ’éšŠäººæ½®ã€‚', hours: '09:00â€“18:00', price: 'ç´„ â‚¬20', transportType: 'public', travelTime: '30m', isNoteExpanded: false },
                    { id: 702, name: 'è–å½¼å¾—å¤§æ•™å ‚', category: 'sightseeing', startTime: '11:00', address: 'Basilica di San Pietro', note: 'åƒè§€å¤§æ®¿ã€åœ°çª–å¢“å®¤ï¼ˆå¯é¸ç™»é ‚ï¼‰ã€‚', hours: '07:00â€“18:30', price: 'å…è²»/ç™»é ‚ â‚¬10', transportType: 'walk', travelTime: '10m', isNoteExpanded: false },
                    { id: 703, name: 'åˆé¤ï¼šæ¢µè’‚å²¡å‘¨é‚Š', category: 'food', startTime: '13:00', address: 'æ¢µè’‚å²¡é™„è¿‘é¤å»³', note: 'ç°¡é¤ã€‚', hours: null, price: null, transportType: 'walk', travelTime: '0m', isNoteExpanded: false },
                    { id: 704, name: 'è–æ¯å¤§æ®¿', category: 'sightseeing', startTime: '15:30', address: 'Basilica di Santa Maria Maggiore', note: 'ç¾…é¦¬å››å¤§è–æ®¿ä¹‹ä¸€ã€‚', hours: '07:00â€“18:30', price: 'å…è²»', transportType: 'public', travelTime: '25m', isNoteExpanded: false },
                    { id: 705, name: 'è¥¿ç­ç‰™å»£å ´èˆ‡è¥¿ç­ç‰™éšæ¢¯', category: 'sightseeing', startTime: '17:30', address: 'Piazza di Spagna', note: 'é€›è¡—ã€æ‹ç…§ã€‚', hours: null, price: 'å…è²»', transportType: 'public', travelTime: '15m', isNoteExpanded: false },
                    { id: 706, name: 'æ™šé¤ï¼šç¾…é¦¬è±ªè¯æ™šé¤', category: 'food', startTime: '20:00', address: 'è¥¿ç­ç‰™å»£å ´é™„è¿‘é¤å»³', note: 'äº«å—åœ¨ç¾…é¦¬çš„æœ€å¾Œä¸€æ™šã€‚', hours: null, price: null, transportType: 'walk', travelTime: '10m', isNoteExpanded: false },
                ],
                // Day 8: 12/21 (æ—¥) ç¾…é¦¬/è¿”ç¨‹
                [
                    { id: 801, name: 'æ—©é¤èˆ‡ä¼´æ‰‹ç¦®æ¡è²·', category: 'food', startTime: '09:00', address: 'Termini è»Šç«™é™„è¿‘', note: 'åœ¨å¸‚å€é€²è¡Œæœ€å¾Œçš„è³¼ç‰©èˆ‡æ¡è²·ã€‚', hours: null, price: null, transportType: 'walk', travelTime: '10m', isNoteExpanded: false },
                    { id: 802, name: 'é€€æˆ¿ä¸¦å‰å¾€æ©Ÿå ´', category: 'accommodation', startTime: '12:00', address: 'ç¾…é¦¬è²çƒç±³å¥‡è«¾æ©Ÿå ´ (FCO)', note: 'æ­ä¹˜ç«è»Šæˆ–è¨ˆç¨‹è»Šå‰å¾€æ©Ÿå ´ã€‚', hours: null, price: 'ç´„ â‚¬15', transportType: 'public', travelTime: '1h', isNoteExpanded: false },
                    { id: 803, name: 'æ©Ÿå ´å ±åˆ°èˆ‡åˆé¤', category: 'flight', startTime: '13:00', address: 'ç¾…é¦¬è²çƒç±³å¥‡è«¾æ©Ÿå ´ (FCO)', note: 'é è¨ˆ 15:00 èµ·é£›ã€‚', hours: null, price: null, transportType: 'walk', travelTime: '0m', isNoteExpanded: false },
                    { id: 804, name: 'ç¾…é¦¬ FCO èµ·é£›', category: 'flight', startTime: '15:00', address: 'TPE å°åŒ— (ç¶“è½‰æ©Ÿ)', note: 'æ­ä¹˜ç­æ©Ÿè¿”å®¶ã€‚', hours: null, price: null, transportType: 'flight', travelTime: '14h', isNoteExpanded: false },
                ],
            ]);

            // ç¾©å¤§åˆ©å†¬å­£æ°£æº« (12æœˆä¸­æ—¬) åŠæ¯æ—¥åŒ¯ç‡ï¼ˆæ¨¡æ“¬æµ®å‹•ï¼‰
            const weatherData = ref([
                { condition: 'cloudy', temp: '8/3', feel: '5', exchangeRate: 35.15 }, // ç±³è˜­ (12/14)
                { condition: 'rain', temp: '7/2', feel: '4', exchangeRate: 34.90 },    // ç±³è˜­ (12/15)
                { condition: 'fog', temp: '6/1', feel: '3', exchangeRate: 35.22 },     // ç±³è˜­â†’å¨å°¼æ–¯ (12/16)
                { condition: 'rain', temp: '10/5', feel: '7', exchangeRate: 35.05 },   // å¨å°¼æ–¯â†’ä½›ç¾…å€«æ–¯ (12/17)
                { condition: 'sunny', temp: '11/6', feel: '9', exchangeRate: 35.30 },  // ä½›ç¾…å€«æ–¯ (12/18)
                { condition: 'cloudy', temp: '13/7', feel: '11', exchangeRate: 35.18 },// ä½›ç¾…å€«æ–¯â†’ç¾…é¦¬ (12/19)
                { condition: 'sunny', temp: '14/8', feel: '12', exchangeRate: 35.45 }, // ç¾…é¦¬/æ¢µè’‚å²¡ (12/20)
                { condition: 'sunny', temp: '15/9', feel: '13', exchangeRate: 35.25 }, // ç¾…é¦¬/è¿”ç¨‹ (12/21)
            ]);
            
            // æ¯æ—¥ç©¿æ­ç´€éŒ„ (æ–°å¢ image å±¬æ€§)
            const outfitData = ref([
                { theme: 'æ—…è¡Œèˆ’é©é¢¨', items: 'å¯¬é¬†æ£‰éº»è¥¯è¡«ã€é‡ç¹”èƒŒå¿ƒã€é‹å‹•ä¼‘é–’é‹', note: 'é•·é€”é£›è¡Œï¼Œä»¥èˆ’é©ç‚ºä¸»ï¼Œå‚™ç”¨è¼•è–„å¤–å¥—ã€‚', image: null }, 
                { theme: 'ç±³è˜­æ™‚å°šè¡—æ‹', items: 'é»‘è‰²ç¾Šæ¯›å¤§è¡£ã€é«˜é ˜æ¯›è¡£ã€çš®è¤²ã€é«˜è·ŸçŸ­é´', note: 'ç±³è˜­å¤§æ•™å ‚æ‹ç…§ç”¨ï¼Œè¦ä¿æš–ã€‚', image: null },
                { theme: 'å¨å°¼æ–¯æµªæ¼«æ°´éƒ½', items: 'é¢¨è¡£ã€é˜²æ°´é‹ã€èµ¤é™¶è‰²åœå·¾', note: 'å¯èƒ½ä¸‹é›¨æˆ–æœ‰éœ§ï¼Œä¿æš–å’Œé˜²æ°´æ˜¯é‡é»ã€‚', image: null },
                { theme: 'ä½›ç¾…å€«æ–¯æ–‡è—å¾©èˆˆ', items: 'é§è‰²é•·æ¬¾å¤§è¡£ã€è²é›·å¸½ã€ç™¾è¤¶è£™', note: 'ç™»é ‚ç™¾èŠ±å¤§æ•™å ‚ï¼Œè¡Œå‹•è¦æ–¹ä¾¿ã€‚', image: null },
                { theme: 'ç±³é–‹æœ—åŸºç¾…å¤•é™½', items: 'ç¾½çµ¨èƒŒå¿ƒã€ç‰›ä»”è¤²ã€ç™»å±±é´', note: 'å‚æ™šå±±é ‚é¢¨å¤§ï¼Œéœ€åŠ å¼·ä¿æš–ã€‚', image: null },
                { theme: 'ç¾…é¦¬å¤è‘—æ¢éšªå®¶', items: 'æ·±æ£•è‰²å¤¾å…‹ã€åšå¯¦Tæ¤ã€åˆ‡çˆ¾è¥¿é´', note: 'ç«¶æŠ€å ´æœ‰å¾ˆå¤šéšæ¢¯ï¼Œç©¿è‘—èˆ’é©ï¼Œé¡è‰²è¦åŒ¹é…å¤è¹Ÿçš„åœŸè‰²ã€‚', image: null },
                { theme: 'æ¢µè’‚å²¡èŠåš´é¢¨', items: 'éè†é€£è¡£è£™ã€æ·±è‰²å¤–å¥—ã€åœå·¾', note: 'é€²å…¥æ•™å ‚éœ€é®è“‹è‚©è†€å’Œè†è“‹ã€‚', image: null },
                { theme: 'è¿”ç¨‹ç°¡ç´„é¢¨', items: 'èˆ’æœçš„ä¼‘é–’æœï¼Œå£“ç¸®è¥ª', note: 'é•·é€”é£›è¡Œï¼Œä¸€åˆ‡å¾ç°¡ã€‚', image: null },
            ]);
            
            // è³¼ç‰©æ¸…å–® (æœªè®Šæ›´)
            const shoppingList = ref([
                { name: 'Aperol Spritz ææ–™', image: 'https://placehold.co/100/F0F3BD/005e8a?text=Aperol' },
                { name: 'ç¾©å¤§åˆ©çœŸçš®çš®ä»¶', image: 'https://placehold.co/100/A0A0A0/ffffff?text=Leather' },
            ]);

            // èŠ±è²»ç´€éŒ„ (æœªè®Šæ›´)
            const expenses = ref([
                { name: 'æ©Ÿç¥¨è²»ç”¨ (TWD)', amount: 1500, category: 'flight', date: '2025-09-01', payment: 'card' },
                { name: 'ç±³è˜­ä¸­å¤®è»Šç«™å·´å£«', amount: 10, category: 'transport', date: '2025-12-14', payment: 'cash' },
                { name: 'ç¾…é¦¬ç«¶æŠ€å ´é–€ç¥¨', amount: 24, category: 'ticket', date: '2025-12-19', payment: 'card' },
                { name: 'ä½›ç¾…å€«æ–¯ç‰›æ’æ™šé¤', amount: 80, category: 'food', date: '2025-12-18', payment: 'cash' },
            ]);

            // --- ç‹€æ…‹æ§åˆ¶ ---
            const selectedDateIndex = ref(0);
            const showShoppingModal = ref(false);
            const showExpenseModal = ref(false);
            const showItineraryModal = ref(false);
            const isEditMode = ref(false); 
            
            // æ–°å¢/ç·¨è¼¯è¡Œç¨‹ç‹€æ…‹
            const newItinerary = ref({
                id: null, name: '', category: 'sightseeing', startTime: '', hours: '', address: '', price: '', note: '', transportType: 'public', travelTime: '', isNoteExpanded: false
            });
            // æ–°å¢è³¼ç‰©ç‹€æ…‹
            const newShoppingItem = ref({
                name: '', image: null
            });
            // æ–°å¢èŠ±è²»ç‹€æ…‹
            const newExpense = ref({
                name: '', amount: null, category: 'food', date: new Date().toISOString().substring(0, 10), payment: 'cash'
            });

            // AI ç‹€æ…‹ (æœªè®Šæ›´)
            const translateInput = ref('');
            const translationOutput = ref('');
            const translationError = ref('');
            const isTranslating = ref(false);
            const isRecommendationLoading = ref({}); // { index: boolean }
            const recommendationOutput = ref({}); // { index: { text: string, sources: [] } }
            const qnaInput = ref('');
            const qnaOutput = ref({ text: '', sources: [] });
            const qnaError = ref('');
            const isQNALoading = ref(false);
            
            // è²¨å¹£è½‰æ› (åˆå§‹å€¼ç‚ºæ­å…ƒ)
            const currencyInput = ref(100);
            const currencyResult = ref(0);
            
            // --- Computed Properties ---
            
            const currentItinerary = computed(() => {
                if (!itineraryData.value[selectedDateIndex.value]) {
                    itineraryData.value[selectedDateIndex.value] = [];
                }
                return itineraryData.value[selectedDateIndex.value];
            });

            const currentOutfit = computed(() => {
                // ç¢ºä¿ outfitData å­˜åœ¨
                if (!outfitData.value[selectedDateIndex.value]) {
                    // å¦‚æœæ•¸æ“šä¸Ÿå¤±ï¼Œæä¾›é»˜èªç©ºå€¼ï¼ŒåŒ…å«æ–°çš„ image å±¬æ€§
                    outfitData.value[selectedDateIndex.value] = { theme: '', items: '', note: '', image: null };
                }
                return outfitData.value[selectedDateIndex.value];
            });

            const totalExpensesEUR = computed(() => {
                return expenses.value.reduce((sum, exp) => {
                    // é€™è£¡ç°¡å–®åœ°å°‡æ‰€æœ‰ expense.amount è¦–ç‚º EUR
                    return sum + exp.amount;
                }, 0);
            });

            const totalExpensesTWD = computed(() => {
                // é€™è£¡ä½¿ç”¨åŸºæº–åŒ¯ç‡é€²è¡Œè½‰æ›
                return Math.round(totalExpensesEUR.value * EXCHANGE_RATE);
            });
            
            // --- ç©¿æ­å„²å­˜åŠŸèƒ½ ---
            const saveOutfit = () => {
                // ç”±æ–¼ currentOutfit æ˜¯ computed ä¸”é›™å‘ç¶å®šåˆ°è¡¨å–®ï¼Œç›´æ¥ä¿®æ”¹å…¶åº•å±¤æ•¸çµ„å³å¯
                if (currentOutfit.value.theme.trim() || currentOutfit.value.items.trim() || currentOutfit.value.note.trim() || currentOutfit.value.image) {
                    console.log(`Day ${selectedDateIndex.value + 1} ç©¿æ­å·²å„²å­˜ã€‚`);
                } else {
                    console.warn(`Day ${selectedDateIndex.value + 1} ç©¿æ­ç‚ºç©ºï¼Œä½†å·²å„²å­˜ã€‚`);
                }
            };
            
            // --- åœ–ç‰‡ä¸Šå‚³è™•ç† (æ–°å¢) ---
            const handleOutfitImageUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // è¨­å®šç•¶å‰é¸å®šæ—¥æœŸä¸‹çš„ outfit image
                        outfitData.value[selectedDateIndex.value].image = e.target.result; 
                    };
                    reader.readAsDataURL(file);
                }
            };

            // --- Utility Functions (æœªè®Šæ›´) ---
            
            const formatNumber = (num) => {
                if (num === 0 || num === null || num === undefined) return '0';
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
            };
            
            // ç°¡å–® Markdown è½‰ HTML (æ”¯æ´æ›è¡Œã€ç²—é«”)
            const formatMarkdown = (text) => {
                if (!text) return '';
                // ç²—é«”
                let html = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                // åˆ—è¡¨ (ç”¨æ–¼ AI è¼¸å‡º)
                html = html.replace(/^- (.*)$/gm, '<li><i class="fa-solid fa-circle-dot text-ai-pink text-[8px] mr-2"></i> $1</li>').replace(/<ul>/g, '').replace(/<\/ul>/g, '');
                 // æ›è¡Œ
                html = html.replace(/\n/g, '<br>');
                return html;
            };

            // å–å¾—é¡è‰²/åœ–ç¤º/æè¿°
            const getCategoryColor = (category) => CATEGORY_MAP[category]?.color || CATEGORY_MAP.other.color;
            const getCategoryIcon = (category) => CATEGORY_MAP[category]?.icon || CATEGORY_MAP.other.icon;
            const getCategoryLabel = (category) => CATEGORY_LABEL_MAP[category] || 'å…¶ä»–';
            const getWeatherIcon = (condition) => {
                const map = {
                    snow: 'fa-solid fa-snowflake',
                    sunny: 'fa-solid fa-sun',
                    cloudy: 'fa-solid fa-cloud',
                    rain: 'fa-solid fa-cloud-showers-heavy',
                    fog: 'fa-solid fa-smog',
                };
                return map[condition] || 'fa-solid fa-cloud-question';
            };
            const getWeatherDescription = (condition) => {
                const map = {
                    snow: 'é™é›ª',
                    sunny: 'æ™´æœ—',
                    cloudy: 'å¤šé›²/é™°å¤©',
                    rain: 'é™é›¨',
                    fog: 'éœ§/é™°å¤©'
                };
                return map[condition] || 'å¤©æ°£è³‡è¨Šæœªå®š';
            };
            const getTransportIcon = (type) => {
                const map = {
                    walk: 'fa-solid fa-person-walking',
                    car: 'fa-solid fa-car-side',
                    bus: 'fa-solid fa-bus-simple',
                    public: 'fa-solid fa-train-subway',
                    flight: 'fa-solid fa-plane',
                    other: 'fa-solid fa-arrow-right-long'
                };
                // ç¾©å¤§åˆ©ä¸»è¦é å…¬å…±äº¤é€šæˆ–æ­¥è¡Œ
                return map[type] || 'fa-solid fa-arrow-right-long';
            };

            // åœ°åœ–åŠŸèƒ½ (åŸæ¨£ä¿ç•™)
            const openMap = (query) => {
                if (query) {
                    const url = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(query)}`;
                    window.open(url, '_blank');
                }
            };

            const openMapDirections = (startItem, endItem) => {
                const origin = startItem.address || startItem.name;
                const destination = endItem.address || endItem.name;
                
                if (origin && destination) {
                    // é è¨­ç‚ºå…¬å…±äº¤é€šï¼Œé™¤éæ˜ç¢ºæ˜¯è‡ªé§• (car)
                    const travelMode = (endItem.transportType === 'car') ? 'driving' : 
                                       (endItem.transportType === 'public') ? 'transit' : 
                                       'walking';
                    const url = `https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}&travelmode=${travelMode}`;
                    window.open(url, '_blank');
                } else {
                    console.error('ç§»å‹•å…©é»é–“è‡³å°‘éœ€è¦ä¸€å€‹åœ°é»åç¨±æˆ–åœ°å€ã€‚');
                }
            };
            
            // --- åŒ¯ç‡è¨ˆç®— (åŸæ¨£ä¿ç•™) ---
            const calculateCurrency = () => {
                // æ­å…ƒè½‰å°å¹£
                currencyResult.value = Math.round(currencyInput.value * EXCHANGE_RATE_EUR);
            };

            // --- æ¨¡æ…‹çª—åŠæŒ‰éˆ•è™•ç† (åŸæ¨£ä¿ç•™) ---

            // æµ®å‹•æŒ‰éˆ•é»æ“Šè™•ç†
            const handleAddClick = () => {
                if (currentTab.value === 'itinerary') {
                    resetItineraryForm();
                    showItineraryModal.value = true;
                } else if (currentTab.value === 'shopping') {
                    resetShoppingForm();
                    showShoppingModal.value = true;
                } else if (currentTab.value === 'expenses') {
                    resetExpenseForm();
                    showExpenseModal.value = true;
                }
            };
            
            // --- è¡Œç¨‹ç®¡ç† (åŸæ¨£ä¿ç•™) ---
            const resetItineraryForm = () => {
                isEditMode.value = false;
                newItinerary.value = {
                    id: Date.now(), name: '', category: 'sightseeing', startTime: '', hours: '', address: '', price: '', note: '', transportType: 'public', travelTime: '', isNoteExpanded: false
                };
            };

            const editItem = (item) => {
                isEditMode.value = true;
                newItinerary.value = JSON.parse(JSON.stringify(item)); 
                showItineraryModal.value = true;
            };

            const saveItineraryItem = () => {
                if (!newItinerary.value.name) {
                    console.error('è¡Œç¨‹åç¨±ä¸èƒ½ç‚ºç©º');
                    return;
                }
                
                if (isEditMode.value) {
                    const index = currentItinerary.value.findIndex(item => item.id === newItinerary.value.id);
                    if (index !== -1) {
                        currentItinerary.value[index] = { ...newItinerary.value };
                    }
                } else {
                    const newItem = { ...newItinerary.value };
                    newItem.id = Date.now();
                    itineraryData.value[selectedDateIndex.value].push(newItem);
                }
                
                itineraryData.value[selectedDateIndex.value] = [...currentItinerary.value];
                
                showItineraryModal.value = false;
                isEditMode.value = false;
            };
            
            // åˆªé™¤è¡Œç¨‹é …ç›®åŠŸèƒ½
            const removeItineraryItem = (id) => {
                console.warn('è¡Œç¨‹é …ç›®å·²åˆªé™¤ã€‚');
                const currentList = itineraryData.value[selectedDateIndex.value];
                const index = currentList.findIndex(item => item.id === id);
                
                if (index !== -1) {
                    currentList.splice(index, 1);
                    itineraryData.value[selectedDateIndex.value] = [...currentList];
                    showItineraryModal.value = false;
                    isEditMode.value = false;
                }
            };
            
            // è¡Œç¨‹ä¸Šä¸‹ç§»å‹• (åŸæ¨£ä¿ç•™)
            const moveItinerary = (id, direction) => {
                const currentList = currentItinerary.value;
                const index = currentList.findIndex(item => item.id === id);
                if (index === -1) return;
                const newIndex = index + direction;
                if (newIndex >= 0 && newIndex < currentList.length) {
                    const item = currentList.splice(index, 1)[0];
                    currentList.splice(newIndex, 0, item);
                    itineraryData.value[selectedDateIndex.value] = [...currentList];
                }
            };

            const moveItineraryUp = (id) => moveItinerary(id, -1);
            const moveItineraryDown = (id) => moveItinerary(id, 1);


            // --- è³¼ç‰©æ¸…å–®ç®¡ç† (åŸæ¨£ä¿ç•™) ---
            const resetShoppingForm = () => {
                newShoppingItem.value = { name: '', image: null };
            };
            
            const handleImageUpload = (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        newShoppingItem.value.image = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            };

            const addShoppingItem = () => {
                if (newShoppingItem.value.name.trim() === '') {
                    console.error('å•†å“åç¨±ä¸èƒ½ç‚ºç©ºï¼');
                    return;
                }
                shoppingList.value.push({ ...newShoppingItem.value });
                showShoppingModal.value = false;
                resetShoppingForm();
            };

            const removeShoppingItem = (index) => {
                shoppingList.value.splice(index, 1);
            };

            // --- èŠ±è²»ç®¡ç† (åŸæ¨£ä¿ç•™) ---
            const resetExpenseForm = () => {
                newExpense.value = { name: '', amount: null, category: 'food', date: new Date().toISOString().substring(0, 10), payment: 'cash' };
            };

            const addExpense = () => {
                if (newExpense.value.name.trim() === '' || newExpense.value.amount === null || newExpense.value.amount <= 0) {
                    console.error('è«‹è¼¸å…¥æœ‰æ•ˆåç¨±å’Œé‡‘é¡ï¼');
                    return;
                }
                expenses.value.push({ ...newExpense.value });
                expenses.value.sort((a, b) => new Date(b.date) - new Date(a.date)); 
                showExpenseModal.value = false;
                resetExpenseForm();
            };

            const removeExpense = (index) => {
                expenses.value.splice(index, 1);
            };


            // --- Gemini API Call Utility (Private) --- (æœªè®Šæ›´)
            const callGeminiApi = async (systemPrompt, userQuery, useGrounding = true) => {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${API_KEY}`;
                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    tools: useGrounding ? [{ "google_search": {} }] : undefined, 
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };

                let response = null;
                let attempt = 0;
                const maxRetries = 5;

                while (attempt < maxRetries) {
                    try {
                        response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        if (response.ok) {
                            break; 
                        } else if (response.status === 429 && attempt < maxRetries - 1) {
                            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            attempt++;
                        } else {
                            const errorData = await response.json();
                            throw new Error(`API Error: ${response.status} - ${errorData.error?.message || response.statusText}`);
                        }
                    } catch (error) {
                        if (attempt === maxRetries - 1) {
                             throw new Error(`Failed to fetch content after ${maxRetries} attempts: ${error.message}`);
                        }
                        attempt++; 
                    }
                }
                
                if (!response || !response.ok) {
                    throw new Error("API call failed and could not be recovered.");
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (!candidate || !candidate.content?.parts?.[0]?.text) {
                    throw new Error("API response was invalid or contained no generated text.");
                }

                const text = candidate.content.parts[0].text;
                let sources = [];
                const groundingMetadata = candidate.groundingMetadata;
                
                if (useGrounding && groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title);
                }

                return { text, sources };
            };

            // --- Gemini Feature 1: Quick Translation (ç¾©å¤§åˆ©æ–‡) --- (æœªè®Šæ›´)
            
            const translatePhrase = async () => {
                const phrase = translateInput.value.trim();
                translationError.value = '';
                translationOutput.value = '';

                if (!phrase) {
                    translationError.value = 'è«‹è¼¸å…¥è¦ç¿»è­¯çš„è©å¥ã€‚';
                    return;
                }

                isTranslating.value = true;

                const systemPrompt = "ä½ æ˜¯ä¸€ä½å°ˆé–€çš„ç¾©å¤§åˆ©æ–‡ç¿»è­¯æ©Ÿå™¨äººã€‚ä½ çš„ä»»å‹™æ˜¯å°‡ç”¨æˆ¶è¼¸å…¥çš„ä¸­æ–‡ç¿»è­¯æˆç¾©å¤§åˆ©æ–‡ï¼Œæˆ–å°‡ç¾©å¤§åˆ©æ–‡ç¿»è­¯æˆä¸­æ–‡ã€‚è«‹æä¾›æ¸…æ™°ã€è‡ªç„¶çš„ç¿»è­¯çµæœï¼Œä¸¦åŒæ™‚æä¾›ç¾©å¤§åˆ©æ–‡çš„ç¾…é¦¬æ‹¼éŸ³ï¼ˆç™¼éŸ³æŒ‡å—ï¼‰ã€‚ä½ åªéœ€è¦è¼¸å‡ºç¿»è­¯çµæœï¼Œä¸è¦æœ‰ä»»ä½•é¡å¤–çš„èªªæ˜æˆ–å°è©±ã€‚";

                const userQuery = `è«‹ç¿»è­¯é€™å¥è©±ï¼Œä¸¦æä¾›ç¾©å¤§åˆ©æ–‡çš„ç¾…é¦¬æ‹¼éŸ³ï¼ˆç™¼éŸ³æŒ‡å—ï¼‰ï¼š"${phrase}"`;

                try {
                    // Use non-grounded call for faster translation
                    const { text } = await callGeminiApi(systemPrompt, userQuery, false); 
                    translationOutput.value = text;
                    translationError.value = '';

                } catch (error) {
                    translationOutput.value = '';
                    translationError.value = `ç¿»è­¯å¤±æ•—ã€‚éŒ¯èª¤: ${error.message}`;
                } finally {
                    isTranslating.value = false;
                }
            };

            // --- Gemini Feature 2: Recommendation Generator (è¡Œç¨‹å»ºè­°) --- (æœªè®Šæ›´)

            const getRecommendation = async (dayIndex) => {
                const day = dates.value[dayIndex];
                const itinerary = itineraryData.value[dayIndex];
                const city = itinerary[0].address.split('(')[1]?.replace(')', '').trim() || 'ç¾…é¦¬'; // å¾ç¬¬ä¸€å€‹è¡Œç¨‹åœ°å€ç²å–åŸå¸‚
                const plannedActivities = itinerary.map(i => `${i.startTime}: ${i.name}`).join('; ');

                if (isRecommendationLoading.value[dayIndex]) return;

                isRecommendationLoading.value = { ...isRecommendationLoading.value, [dayIndex]: true };
                recommendationOutput.value = { ...recommendationOutput.value, [dayIndex]: { text: 'AI æ­£åœ¨æ ¹æ“šæ‚¨çš„è¡Œç¨‹æŸ¥æ‰¾æœ€ä½³å»ºè­°...', sources: [] } };
                
                // æ»¾å‹•åˆ°å¡ç‰‡åº•éƒ¨ï¼Œé¡¯ç¤ºè®€å–ç‹€æ…‹
                const recommendBtn = document.getElementById(`recommendBtn-${dayIndex}`);
                if (recommendBtn) {
                     recommendBtn.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }
                
                const systemPrompt = `ä½ æ˜¯ä¸€ä½ç¾©å¤§åˆ©æ—…éŠå°ˆå®¶ã€‚è«‹æ ¹æ“šç”¨æˆ¶æä¾›çš„åŸå¸‚å’Œç•¶æ—¥è¡Œç¨‹ï¼Œç‚ºä»–å€‘æ¨è–¦ä¸€å€‹æ™šé¤åœ°é»æˆ–ä¸€å€‹ç¬¦åˆç•¶æ—¥è¡Œç¨‹ä¸»é¡Œçš„é¡å¤–æ´»å‹•ã€‚
è¦å‰‡ï¼š
1. å¿…é ˆä½¿ç”¨ç¹é«”ä¸­æ–‡ã€‚
2. æ¨è–¦å…§å®¹å¿…é ˆä½¿ç”¨ Google Search é€²è¡Œé©—è­‰ï¼Œç¢ºä¿è³‡è¨Šæ˜¯æœ€æ–°ä¸”æº–ç¢ºçš„ã€‚
3. è¼¸å‡ºæ ¼å¼å¿…é ˆæ˜¯æ¸…æ™°çš„ Markdown åˆ—è¡¨ï¼ŒåŒ…å«åç¨±ã€åœ°å€/åœ°é»ã€ç‰¹è‰²æè¿°å’Œæ¨è–¦åŸå› ã€‚
4. å¦‚æœæ˜¯é¤å»³ï¼Œè«‹å¼·èª¿è©²é¤å»³çš„ç‰¹è‰²èœæˆ–æ°›åœã€‚
5. è¼¸å‡ºå…§å®¹ä¸è¦åŒ…å«ä»»ä½•å‰è¨€æˆ–çµèªï¼Œç›´æ¥å¾æ¨è–¦å…§å®¹é–‹å§‹ã€‚`;

                const userQuery = `è«‹åœ¨ ${day.date} (åŸå¸‚: ${city}) çš„è¡Œç¨‹çµæŸå¾Œï¼Œç‚ºæˆ‘æ¨è–¦ä¸€å€‹ä»Šæ™šçš„æ™šé¤åœ°é»ï¼Œæˆ–æ˜¯ä¸€å€‹è¼•é¬†çš„é¡å¤–æ´»å‹•ã€‚
ä»Šæ—¥é å®šæ´»å‹•ï¼š${plannedActivities}
è«‹ä½¿ç”¨æœ€æ–°è³‡è¨Šä¸¦ç¢ºä¿æ¨è–¦ç¬¦åˆç•¶åœ°çš„ç‰¹è‰²å’Œæ°›åœã€‚`;

                try {
                    const { text, sources } = await callGeminiApi(systemPrompt, userQuery);
                    
                    recommendationOutput.value = { ...recommendationOutput.value, [dayIndex]: { text: text, sources: sources } };

                } catch (error) {
                    recommendationOutput.value = { ...recommendationOutput.value, [dayIndex]: { text: `ç„¡æ³•ç²å–æ¨è–¦ã€‚éŒ¯èª¤: ${error.message}`, sources: [] } };

                } finally {
                    isRecommendationLoading.value = { ...isRecommendationLoading.value, [dayIndex]: false };
                }
            };
            
            // --- Gemini Feature 3: QNA (æ—…éŠå•ç­”) --- (æœªè®Šæ›´)
            
            const searchQNA = async () => {
                const query = qnaInput.value.trim();
                qnaError.value = '';
                qnaOutput.value = { text: '', sources: [] };

                if (!query) {
                    qnaError.value = 'è«‹è¼¸å…¥æ‚¨çš„å•é¡Œã€‚';
                    return;
                }
                
                isQNALoading.value = true;
                qnaOutput.value = { text: 'AI æ­£åœ¨æœå°‹ä¸¦ç”Ÿæˆç­”æ¡ˆ...', sources: [] };

                const systemPrompt = "ä½ æ˜¯ä¸€ä½ç¾©å¤§åˆ©æ—…éŠçŸ¥è­˜å°ˆå®¶ã€‚è«‹æ ¹æ“šæœ€æ–°çš„ç¶²è·¯è³‡è¨Šï¼Œä»¥ç¹é«”ä¸­æ–‡ç°¡æ½”ã€å°ˆæ¥­åœ°å›ç­”ç”¨æˆ¶é—œæ–¼ç¾©å¤§åˆ©æ—…éŠçš„ä»»ä½•å•é¡Œã€‚å‹™å¿…ä½¿ç”¨ Google Search é€²è¡Œè³‡è¨Šé©—è­‰ã€‚";
                
                try {
                    const { text, sources } = await callGeminiApi(systemPrompt, query, true); 
                    
                    qnaOutput.value = { text: text, sources: sources };
                    qnaError.value = '';

                } catch (error) {
                    qnaOutput.value = { text: '', sources: [] };
                    qnaError.value = `æŸ¥æ‰¾å¤±æ•—ã€‚éŒ¯èª¤: ${error.message}`;
                } finally {
                    isQNALoading.value = false;
                }
            };


            // è¼‰å…¥æ™‚åŸ·è¡Œ
            onMounted(() => {
                calculateCurrency();
                // åˆå§‹è¼‰å…¥æ™‚å°‡ expense æ’åº (æœ€æ–°åˆ°æœ€èˆŠ)
                expenses.value.sort((a, b) => new Date(b.date) - new Date(a.date));
            });

            return {
                currentTab, dates, selectedDateIndex, itineraryData, currentItinerary,
                hotels, shoppingList, expenses, totalExpensesEUR, totalExpensesTWD,
                weatherData, currencyInput, currencyResult, calculateCurrency, EXCHANGE_RATE_EUR,
                getCategoryColor, getCategoryIcon, getCategoryLabel, getWeatherIcon, getTransportIcon, getWeatherDescription,
                showShoppingModal, showExpenseModal, showItineraryModal, isEditMode,
                newShoppingItem, newExpense, newItinerary,
                handleAddClick, handleImageUpload, addShoppingItem, removeShoppingItem,
                addExpense, removeExpense, editItem, saveItineraryItem,
                removeItineraryItem, 
                moveItineraryUp, moveItineraryDown, 
                openMap, openMapDirections, formatNumber,
                
                // Outfit Feature
                outfitData, currentOutfit, saveOutfit, handleOutfitImageUpload,
                
                // AI Features
                translatePhrase, isTranslating, translationOutput, translateInput, translationError,
                getRecommendation, isRecommendationLoading, recommendationOutput, formatMarkdown,
                searchQNA, qnaInput, qnaOutput, qnaError, isQNALoading
            };
        }
    }).mount('#app');
</script>
</body>
</html>
